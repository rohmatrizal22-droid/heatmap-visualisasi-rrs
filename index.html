<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data Entry & Analisis</title>
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: #f3f4f6; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(209, 213, 219, 0.5);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .draggable-header { cursor: grab; }
        .draggable-header:active { cursor: grabbing; }
        
        /* Input & Button Styles */
        .map-btn { transition: all 0.2s; }
        .map-btn-active { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        .ai-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .prose h1, .prose h2 { font-weight: bold; margin-top: 0.5em; font-size: 1.1em; }
        .prose p { margin-bottom: 0.5em; line-height: 1.5; font-size: 0.9em; }
    </style>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">

    <!-- AI Loading Overlay -->
    <div id="aiProcessing" class="fixed top-4 right-4 bg-white z-[9999] hidden items-center gap-3 p-3 rounded-lg shadow-lg border border-blue-100 animate-bounce-in">
        <div class="loader"></div>
        <span class="text-xs text-gray-700 font-bold">AI Sedang Bekerja...</span>
    </div>

    <!-- DATA ENTRY MODAL (New Feature) -->
    <div id="dataEntryModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300 overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-gray-800 font-bold flex items-center gap-2"><i class="fa-solid fa-database text-blue-600"></i> Input Data Manual</h3>
                <button onclick="toggleDataModal(false)" class="text-gray-400 hover:text-gray-700 text-xl"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <p class="text-sm text-gray-600 mb-2">Masukkan data Anda dengan format: <b>Latitude, Longitude, Tanggal, Jam</b></p>
                <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 font-mono mb-4 border border-blue-100">
                    Contoh:<br>
                    -6.200, 106.816, 2023-11-22, 08:30<br>
                    -6.205, 106.820, 2023-11-22, 09:00<br>
                    <span class="text-gray-500 italic">// Atau cukup Lat, Lon (Waktu akan otomatis saat ini)</span>
                </div>
                <textarea id="dataInputArea" class="w-full h-64 p-4 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" placeholder="Tempel data CSV Anda di sini..."></textarea>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-2">
                <button onclick="generateDummyData()" class="px-4 py-2 text-xs font-bold text-gray-600 hover:bg-gray-200 rounded-lg transition-colors">Gunakan Data Dummy</button>
                <button onclick="processManualInput()" class="px-6 py-2 text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                    <i class="fa-solid fa-check"></i> Tampilkan Data
                </button>
            </div>
        </div>
    </div>

    <!-- AI OUTPUT MODAL -->
    <div id="aiModal" class="fixed inset-0 bg-black/50 z-[9999] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh] transform scale-95 transition-transform duration-300">
            <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-indigo-600 to-purple-600 rounded-t-2xl">
                <h3 class="text-white font-bold flex items-center gap-2"><i class="fa-solid fa-robot"></i> Analisis AI</h3>
                <button onclick="closeAIModal()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="aiOutput" class="p-6 overflow-y-auto prose text-sm text-gray-700 flex-1"></div>
        </div>
    </div>

    <!-- CONTROL PANEL -->
    <div id="controlContainer" class="absolute top-4 left-14 z-[1000] w-80 transition-all duration-300">
        <div id="mainFullContent" class="glass-panel p-4 rounded-xl overflow-hidden">
            <!-- Header -->
            <div class="draggable-header text-sm font-bold text-gray-800 mb-0 border-b border-gray-200 pb-3 flex items-center justify-between select-none" data-target="controlContainer">
                <div class="flex items-center gap-2"><i class="fa-solid fa-layer-group text-blue-600"></i> Visualisasi Data</div>
                <button onclick="toggleMinMax('controlContainer', true)" class="text-gray-400 hover:text-blue-600 p-1 rounded hover:bg-gray-100"><i class="fa-solid fa-compress"></i></button>
            </div>
            
            <div class="space-y-4 mt-3 max-h-[80vh] overflow-y-auto pr-1 custom-scrollbar">
                
                <!-- DATA ENTRY BUTTON -->
                <button onclick="toggleDataModal(true)" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-between group">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-pen-to-square"></i> Input Data</span>
                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>

                <!-- AI COMMAND -->
                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 space-y-2">
                    <label class="text-[10px] font-bold text-indigo-800 uppercase tracking-wider block">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Perintah AI
                    </label>
                    <div class="relative">
                        <input type="text" id="aiCommandInput" placeholder="Cari 'Monas' atau 'Filter jam 08:00'" 
                            class="ai-input w-full text-xs p-2 pr-8 rounded border border-gray-300 bg-white"
                            onkeypress="if(event.key==='Enter') handleAICommand()">
                        <button onclick="handleAICommand()" class="absolute right-1 top-1 text-indigo-600 hover:bg-indigo-100 p-1 rounded transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                    <div class="flex justify-between text-[10px]">
                        <span class="text-gray-500" id="dataCount">0 Data Tersedia</span>
                        <button onclick="resetFilter()" class="text-red-500 hover:underline">Reset Filter</button>
                    </div>
                </div>

                <!-- VISUALIZATION SETTINGS -->
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1.5">Tampilan Peta</label>
                    <div class="grid grid-cols-4 gap-1 bg-gray-100 p-1 rounded-lg">
                        <button class="map-btn map-btn-active text-[10px] py-1.5 rounded" data-map="road" onclick="changeBaseMap('road')">Jalan</button>
                        <button class="map-btn text-[10px] py-1.5 rounded text-gray-600 hover:bg-gray-200" data-map="satellite" onclick="changeBaseMap('satellite')">Satelit</button>
                        <button class="map-btn text-[10px] py-1.5 rounded text-gray-600 hover:bg-gray-200" data-map="hybrid" onclick="changeBaseMap('hybrid')">Hybrid</button>
                        <button class="map-btn text-[10px] py-1.5 rounded text-gray-600 hover:bg-gray-200" data-map="terrain" onclick="changeBaseMap('terrain')">Terrain</button>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1.5">Mode Visual</label>
                    <div class="relative">
                        <select id="viewMode" onchange="renderLayer()" class="w-full bg-white border border-gray-300 text-gray-700 text-xs font-medium rounded-lg focus:ring-blue-500 block p-2.5">
                            <option value="heatmap">üî• Heatmap (Kepadatan)</option>
                            <option value="point">üìç Titik (Detail)</option>
                            <option value="circle">‚≠ï Lingkaran (Radius)</option>
                            <option value="line">üìà Garis (Jalur)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1.5">Ukuran / Radius</label>
                    <input type="range" id="radiusSlider" min="5" max="50" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>
                
                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-100">
                    <button onclick="askAIGeneral()" class="text-xs bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold py-2 px-3 rounded-lg shadow-sm flex items-center justify-center gap-1">
                        <i class="fa-regular fa-file-lines"></i> Laporan
                    </button>
                    <button onclick="askAIArea()" class="text-xs bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold py-2 px-3 rounded-lg shadow-sm flex items-center justify-center gap-1">
                        <i class="fa-solid fa-vector-square"></i> Analisis Area
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Minimized Icon -->
        <div id="mainMiniContent" class="hidden draggable-header glass-panel w-12 h-12 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-50 shadow-lg border-2 border-white hover:scale-110 transition-transform" data-target="controlContainer" onclick="toggleMinMax('controlContainer', false)">
            <i class="fa-solid fa-layer-group text-blue-600 text-lg"></i>
        </div>
    </div>

    <!-- MEASUREMENT PANEL -->
    <div id="measurePanel" class="absolute top-80 left-14 z-[1000] w-72 hidden">
        <div class="glass-panel p-4 rounded-xl">
            <div class="draggable-header text-sm font-bold text-gray-800 mb-2 flex justify-between items-center" data-target="measurePanel">
                <span><i class="fa-solid fa-ruler-combined text-green-600 mr-2"></i>Hasil Ukur</span>
                <button onclick="clearDrawings()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="bg-green-50 border border-green-200 rounded p-3 text-center">
                <span id="measureResult" class="text-2xl font-bold text-green-700 font-mono">0.00</span>
                <span class="text-xs text-green-600 font-bold uppercase ml-1">KM</span>
                <div id="measureDesc" class="text-[10px] text-green-600 mt-1"></div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // --- KONFIGURASI ---
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // State
        let rawData = [], displayData = [], activeLayer = null;
        let currentDrawnLayer = null;
        
        // --- MAP INIT ---
        const map = L.map('map', {center: [-6.200, 106.816], zoom: 11, zoomControl: false, preferCanvas: true});
        L.control.zoom({position: 'bottomright'}).addTo(map);
        
        const baseLayers = {
            'road': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}),
            'satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}),
            'hybrid': L.layerGroup([
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}')
            ]),
            'terrain': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {maxZoom:19})
        };
        baseLayers['road'].addTo(map);

        const drawnItems = new L.FeatureGroup().addTo(map);

        // --- CORE: DATA ENTRY & PARSING ---
        
        function toggleDataModal(show) {
            const m = document.getElementById('dataEntryModal');
            if(show) { m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10); }
            else { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        }

        function processManualInput() {
            const rawText = document.getElementById('dataInputArea').value.trim();
            if(!rawText) return alert("Mohon masukkan data terlebih dahulu.");

            const lines = rawText.split('\n');
            const parsedData = [];
            let errorCount = 0;

            // Format parsing: Lat, Lon, Date, Time (Optional)
            lines.forEach(line => {
                // Bersihkan karakter yg tidak perlu (tanda kutip dsb)
                const cleanLine = line.replace(/['"]/g, '').trim();
                if(!cleanLine) return;

                const parts = cleanLine.split(',').map(p => p.trim());
                
                if(parts.length >= 2) {
                    const lat = parseFloat(parts[0]);
                    const lng = parseFloat(parts[1]);
                    
                    if(!isNaN(lat) && !isNaN(lng)) {
                        // Coba ambil tanggal/waktu dari kolom ke-3 dst
                        let dateStr = parts[2] || "";
                        let timeStr = parts[3] || "";
                        
                        // Jika format gabung (YYYY-MM-DD HH:MM) di kolom 3
                        if (dateStr.includes(' ') && !timeStr) {
                            [dateStr, timeStr] = dateStr.split(' ');
                        }

                        // Fallback waktu sekarang jika kosong
                        const now = new Date();
                        if (!dateStr) dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
                        if (!timeStr) timeStr = now.toTimeString().split(' ')[0].substring(0,5); // HH:MM

                        parsedData.push({ lat, lng, date: dateStr, time: timeStr });
                    } else {
                        errorCount++;
                    }
                }
            });

            if(parsedData.length > 0) {
                rawData = parsedData;
                displayData = [...rawData];
                
                // Zoom ke data
                const bounds = L.latLngBounds(parsedData.map(d => [d.lat, d.lng]));
                map.fitBounds(bounds);
                
                renderLayer();
                document.getElementById('dataCount').innerText = `${parsedData.length} Data`;
                toggleDataModal(false); // Tutup modal
                
                if(errorCount > 0) alert(`Berhasil memuat ${parsedData.length} data. ${errorCount} baris diabaikan karena format salah.`);
            } else {
                alert("Tidak ada data valid yang ditemukan. Pastikan format: Latitude, Longitude");
            }
        }

        function generateDummyData() {
            const dummyText = [];
            const centerLat = -6.200;
            const centerLng = 106.816;
            
            for(let i=0; i<50; i++) {
                const lat = (centerLat + (Math.random() - 0.5) * 0.05).toFixed(6);
                const lng = (centerLng + (Math.random() - 0.5) * 0.05).toFixed(6);
                const date = `2023-11-${Math.floor(Math.random()*30)+1}`;
                const h = String(Math.floor(Math.random()*24)).padStart(2,'0');
                const m = String(Math.floor(Math.random()*60)).padStart(2,'0');
                dummyText.push(`${lat}, ${lng}, ${date}, ${h}:${m}`);
            }
            
            document.getElementById('dataInputArea').value = dummyText.join('\n');
        }

        // --- VISUALIZATION ---

        function renderLayer() {
            // Safety check canvas width
            if(map.getSize().x === 0) { setTimeout(renderLayer, 200); return; }

            if(activeLayer) { map.removeLayer(activeLayer); activeLayer=null; }
            const mode = document.getElementById('viewMode').value;
            const radius = parseInt(document.getElementById('radiusSlider').value);

            if(mode === 'heatmap') {
                activeLayer = L.heatLayer(displayData.map(d => [d.lat, d.lng, 0.8]), {
                    radius: radius, blur: 15, maxZoom: 17
                }).addTo(map);
                
                // KLIK PADA HEATMAP (Fitur Pintar)
                // Karena heatmap tidak bisa diklik langsung, kita pasang listener di map
                // untuk mencari titik data terdekat dari lokasi klik
                map.off('click'); // Hapus listener lama
                map.on('click', function(e) {
                    if(document.getElementById('viewMode').value !== 'heatmap') return;
                    
                    const clickLat = e.latlng.lat;
                    const clickLng = e.latlng.lng;
                    let closest = null;
                    let minDist = Infinity;

                    // Cari titik terdekat (Simple Euclidean distance for speed on small area)
                    displayData.forEach(d => {
                        const dist = Math.sqrt(Math.pow(d.lat - clickLat, 2) + Math.pow(d.lng - clickLng, 2));
                        if(dist < minDist) { minDist = dist; closest = d; }
                    });

                    // Jika jarak cukup dekat (misal < 0.005 derajat)
                    if(closest && minDist < 0.005) {
                        const content = `
                            <div class="text-center font-sans">
                                <b class="text-blue-600">Data Terdekat</b><br>
                                <div class="text-xs text-gray-600 mt-1 border-t pt-1">
                                    üìÖ ${closest.date}<br>
                                    ‚è∞ ${closest.time}<br>
                                    üìç ${closest.lat.toFixed(5)}, ${closest.lng.toFixed(5)}
                                </div>
                            </div>
                        `;
                        L.popup().setLatLng([closest.lat, closest.lng]).setContent(content).openOn(map);
                    }
                });

            } else if (mode === 'line') {
                activeLayer = L.polyline(displayData.map(d => [d.lat, d.lng]), {color: '#2563eb'}).addTo(map);
                map.off('click'); // Matikan deteksi klik heatmap
            } else {
                // POINT / CIRCLE MODE
                activeLayer = L.featureGroup();
                map.off('click'); 

                // Optimasi render max 2000 point
                const renderLimit = Math.min(displayData.length, 2000);
                
                for(let i=0; i<renderLimit; i++) {
                    const d = displayData[i];
                    let marker;
                    
                    // Format Popup HTML yang Bagus
                    const popupContent = `
                        <div class="font-sans text-center min-w-[120px]">
                            <div class="bg-blue-50 text-blue-800 font-bold p-1 rounded-t border-b border-blue-100 text-xs">
                                Data Point #${i+1}
                            </div>
                            <div class="p-2 text-xs text-gray-700 space-y-1">
                                <div class="flex justify-between"><span>üìÖ Tgl:</span> <b>${d.date}</b></div>
                                <div class="flex justify-between"><span>‚è∞ Jam:</span> <b>${d.time}</b></div>
                                <div class="border-t pt-1 mt-1 text-[10px] text-gray-500">
                                    ${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}
                                </div>
                            </div>
                        </div>
                    `;

                    if(mode === 'point') {
                        marker = L.circleMarker([d.lat, d.lng], {
                            radius: radius/4, fillColor: "#f97316", color: "#fff", weight: 1, fillOpacity: 0.9
                        });
                    } else {
                        marker = L.circle([d.lat, d.lng], {
                            radius: radius * 20, color: '#ef4444', weight: 1
                        });
                    }
                    
                    marker.bindPopup(popupContent);
                    marker.addTo(activeLayer);
                }
                activeLayer.addTo(map);
            }
        }

        // --- DRAG LOGIC ---
        let activeDragEl=null, initialX, initialY;
        const dragOffsets = {'controlContainer':{x:0,y:0}, 'measurePanel':{x:0,y:0}};
        
        document.addEventListener("mousedown", function(e) {
            let h = e.target.closest('.draggable-header');
            if(!h || e.target.closest('button') || e.target.closest('input')) return;
            const id = h.getAttribute('data-target');
            if(id) {
                activeDragEl = document.getElementById(id);
                initialX = e.clientX - dragOffsets[id].x;
                initialY = e.clientY - dragOffsets[id].y;
                activeDragEl.style.cursor = 'grabbing';
            }
        });
        document.addEventListener("mouseup", () => { if(activeDragEl){ activeDragEl.style.cursor=''; activeDragEl=null; } });
        document.addEventListener("mousemove", (e) => {
            if(activeDragEl) {
                e.preventDefault();
                const x = e.clientX - initialX;
                const y = e.clientY - initialY;
                dragOffsets[activeDragEl.id] = {x,y};
                activeDragEl.style.transform = `translate3d(${x}px, ${y}px, 0)`;
            }
        });

        // --- UTILS & AI ---
        function changeBaseMap(t) {
            Object.values(baseLayers).forEach(l => map.removeLayer(l));
            map.addLayer(baseLayers[t]);
            document.querySelectorAll('.map-btn').forEach(b => {
                if(b.dataset.map === t) { b.classList.add('map-btn-active'); b.classList.remove('text-gray-600'); }
                else { b.classList.remove('map-btn-active'); b.classList.add('text-gray-600'); }
            });
        }

        document.getElementById('viewMode').addEventListener('change', renderLayer);
        document.getElementById('radiusSlider').addEventListener('input', () => {
            if(document.getElementById('viewMode').value === 'heatmap' && activeLayer) {
                activeLayer.setOptions({radius: parseInt(document.getElementById('radiusSlider').value)});
            } else renderLayer();
        });

        function toggleMinMax(id, min) {
            const c = document.getElementById(id);
            if(min) { c.classList.remove('w-80'); c.classList.add('w-auto'); document.getElementById('mainFullContent').classList.add('hidden'); document.getElementById('mainMiniContent').classList.remove('hidden'); }
            else { c.classList.remove('w-auto'); c.classList.add('w-80'); document.getElementById('mainMiniContent').classList.add('hidden'); document.getElementById('mainFullContent').classList.remove('hidden'); }
        }

        function resetFilter() {
            displayData = [...rawData]; renderLayer();
            document.getElementById('dataCount').innerText = displayData.length + " Data";
            document.getElementById('aiCommandInput').value = "";
        }

        // AI Functions (Simplified for brevity)
        async function handleAICommand() {
            const q = document.getElementById('aiCommandInput').value;
            if(!q) return;
            document.getElementById('aiProcessing').style.display = 'flex';
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{parts:[{text: `Command: "${q}". Context: Data has properties lat, lng, date (YYYY-MM-DD), time (HH:MM). 
                    Return JSON: { "action": "NAVIGATE"|"FILTER", "lat": num, "lng": num, "expression": "JS boolean condition using d.date/d.time/d.lat" }`}]}]})
                });
                const d = await res.json();
                const action = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g,''));
                
                if(action.action === "NAVIGATE") map.flyTo([action.lat, action.lng], 12);
                else if(action.action === "FILTER") {
                    const fn = new Function('d', `try{return ${action.expression}}catch(e){return false}`);
                    const f = rawData.filter(fn);
                    if(f.length){ displayData=f; renderLayer(); document.getElementById('dataCount').innerText = f.length + " (Filter)"; }
                    else alert("0 Data ditemukan.");
                }
            } catch(e) { alert("Gagal memproses perintah AI."); }
            finally { document.getElementById('aiProcessing').style.display = 'none'; }
        }

        // --- DRAW ---
        const drawControl = new L.Control.Draw({
            draw: { polyline: {metric:true}, polygon: {showArea:true, metric:true}, rectangle: {showArea:true, metric:true}, circle: false, marker: false },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);
        map.on(L.Draw.Event.CREATED, e => {
            drawnItems.clearLayers(); drawnItems.addLayer(e.layer); currentDrawnLayer = e.layer;
            document.getElementById('measurePanel').classList.remove('hidden');
            
            // Calculate distance/area (Simplified)
            let val = 0, unit = "KM";
            if(e.layerType === 'polyline') {
                const lls = e.layer.getLatLngs();
                for(let i=0; i<lls.length-1; i++) val += lls[i].distanceTo(lls[i+1]);
            } else {
                const lls = e.layer.getLatLngs()[0]; lls.push(lls[0]);
                for(let i=0; i<lls.length-1; i++) val += lls[i].distanceTo(lls[i+1]);
            }
            document.getElementById('measureResult').innerText = (val/1000).toFixed(2);
        });
        function clearDrawings() { drawnItems.clearLayers(); currentDrawnLayer=null; document.getElementById('measurePanel').classList.add('hidden'); }

    </script>
</body>
</html>