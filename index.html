<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Geo-Analisis (Globe Style)</title>
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: #1a1a1a; } /* Background gelap agar cocok dengan satelit */
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Glass Panel - Modified for Darker Theme contrast */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Loaders & UI Elements */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .draggable-header { cursor: grab; } .draggable-header:active { cursor: grabbing; }
        .map-btn { transition: all 0.2s; font-weight: 600; }
        .map-btn-active { background-color: #eff6ff; border-color: #2563eb; color: #1d4ed8; box-shadow: inset 0 0 0 1px #2563eb; }
        .ai-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        
        /* Table & Forms */
        .data-table-container { max-height: 300px; overflow-y: auto; }
        .data-table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.75rem; }
        .data-table th { position: sticky; top: 0; background: #f9fafb; padding: 8px; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
        .data-table td { padding: 6px 8px; border-bottom: 1px solid #f3f4f6; white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
        .file-drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s; background: #f8fafc; }
        .file-drop-zone:hover { border-color: #3b82f6; background-color: #eff6ff; }

        /* Custom Style Inputs */
        input[type="color"] { -webkit-appearance: none; border: none; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 8px; border: 1px solid #e5e7eb; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .prose p { font-size: 0.9em; line-height: 1.5; }

        /* Settings Sidebar Active State */
        .setting-tab-active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right: 3px solid #2563eb;
        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">

    <!-- Overlays -->
    <div id="aiProcessing" class="fixed top-4 right-4 bg-white z-[9999] hidden items-center gap-3 p-3 rounded-lg shadow-lg border border-blue-100 animate-bounce-in">
        <div class="loader"></div> <span class="text-xs text-gray-700 font-bold">Memproses...</span>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 flex flex-col h-[600px]">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-gray-800 text-lg"><i class="fa-solid fa-sliders text-blue-600 mr-2"></i> Pengaturan Tampilan & Data</h3>
                <button onclick="toggleModal('settingsModal', false)" class="text-gray-400 hover:text-gray-700"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-1/3 bg-gray-50 border-r border-gray-200 p-3 flex flex-col gap-2 overflow-y-auto custom-scrollbar">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 px-2">Mode Visual</div>
                    <button onclick="switchStyleTab('point')" class="style-tab setting-tab-active w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-point"><i class="fa-solid fa-circle-dot text-orange-500"></i> Titik (Point)</button>
                    <button onclick="switchStyleTab('circle')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-circle"><i class="fa-regular fa-circle text-red-500"></i> Lingkaran (Radius)</button>
                    <button onclick="switchStyleTab('line')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-line"><i class="fa-solid fa-route text-blue-500"></i> Garis (Line)</button>
                    <button onclick="switchStyleTab('heatmap')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-heatmap"><i class="fa-solid fa-fire text-red-600"></i> Heatmap</button>
                    <div class="my-2 border-t border-gray-200"></div>
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1 px-2">Sistem</div>
                    <button onclick="switchStyleTab('api')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-api"><i class="fa-solid fa-key text-gray-600"></i> API Key</button>
                </div>
                <div class="w-2/3 p-6 overflow-y-auto custom-scrollbar bg-white relative">
                    <div id="styleContentWrapper">
                        <h4 class="text-lg font-bold text-gray-800 mb-1" id="styleTitle">Pengaturan Heatmap</h4>
                        <p class="text-xs text-gray-500 mb-6">Atur radius, blur, dan sensitivitas kepadatan data.</p>
                        <div id="styleControls" class="space-y-6"></div>
                    </div>
                    <div id="apiContentWrapper" class="hidden">
                        <h4 class="text-lg font-bold text-gray-800 mb-1">Konfigurasi API</h4>
                        <p class="text-xs text-gray-500 mb-6">Koneksikan dashboard dengan Google Gemini AI.</p>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <label class="text-sm font-bold text-blue-800 block mb-2">Gemini API Key</label>
                            <div class="relative">
                                <input type="password" id="apiKeyInput" class="w-full p-3 pr-20 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Tempel API Key di sini...">
                                <button onclick="toggleApiKeyVisibility()" class="absolute right-2 top-3 text-gray-400 hover:text-blue-600"><i class="fa-solid fa-eye" id="eyeIcon"></i></button>
                            </div>
                            <div class="flex justify-end mt-3">
                                <button onclick="saveApiKey()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition-colors"><i class="fa-solid fa-save mr-1"></i> Simpan Key</button>
                            </div>
                            <p class="text-xs text-blue-600 mt-3 flex items-center gap-1"><i class="fa-solid fa-shield-halved"></i> Key disimpan lokal di browser Anda (LocalStorage). Aman untuk GitHub Pages.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-between items-center shrink-0">
                <button onclick="resetStyles()" class="text-red-500 hover:text-red-700 text-sm font-medium px-3">Reset Default</button>
                <button onclick="toggleModal('settingsModal', false)" class="bg-gray-800 hover:bg-gray-900 text-white text-sm px-6 py-2.5 rounded-lg font-bold shadow hover:shadow-lg transition-all">Tutup</button>
            </div>
        </div>
    </div>

    <!-- DATA ENTRY MODAL -->
    <div id="dataEntryModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800"><i class="fa-solid fa-file-excel text-green-600 mr-2"></i> Upload Excel Bebas</h3>
                <button onclick="toggleModal('dataEntryModal', false)" class="text-gray-400 hover:text-gray-700"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-8 flex flex-col items-center">
                <div id="dropZone" class="file-drop-zone w-full h-48 rounded-xl flex flex-col items-center justify-center cursor-pointer mb-4 relative">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-blue-400 mb-3"></i>
                    <p class="text-sm text-gray-600 font-medium">Tarik File Excel ke sini</p>
                    <p class="text-xs text-gray-400 mt-1">Support: .xlsx, .csv (Bisa format "Lat Lon", "Lat,Lon", atau kolom terpisah)</p>
                </div>
                <div id="fileInfo" class="hidden w-full bg-green-50 border border-green-200 rounded-lg p-3 flex justify-between items-center">
                    <span class="text-xs text-green-800 font-medium"><i class="fa-solid fa-check-circle mr-1"></i> <span id="fileName">file.xlsx</span></span>
                    <button onclick="resetUpload()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                </div>
                <button onclick="generateDummyData()" class="mt-4 w-full py-2 text-xs font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg">Generate Data Dummy</button>
            </div>
        </div>
    </div>

    <!-- DATA MANAGER MODAL -->
    <div id="dataManagerModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800"><i class="fa-solid fa-list-check text-blue-600 mr-2"></i> Kelola Data (Otomatis)</h3>
                <button onclick="toggleModal('dataManagerModal', false)" class="text-gray-400 hover:text-gray-700"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs text-gray-500 font-bold">Total: <span id="managerCount">0</span></span>
                    <button onclick="clearAllData()" class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded font-bold hover:bg-red-200">Hapus Semua</button>
                </div>
                <div class="data-table-container border border-gray-200 rounded-lg flex-1 custom-scrollbar">
                    <table class="data-table" id="mainDataTable">
                        <!-- Dynamic Headers will be inserted here -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- AI OUTPUT MODAL -->
    <div id="aiModal" class="fixed inset-0 bg-black/50 z-[9999] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b bg-gradient-to-r from-indigo-600 to-purple-600 rounded-t-2xl flex justify-between items-center">
                <h3 class="text-white font-bold"><i class="fa-solid fa-robot mr-2"></i> Analisis AI</h3>
                <button onclick="closeAIModal()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="aiOutput" class="p-6 overflow-y-auto prose text-sm text-gray-700 flex-1 custom-scrollbar"></div>
        </div>
    </div>

    <!-- MAIN CONTROL PANEL -->
    <div id="controlContainer" class="absolute top-4 left-14 z-[1000] w-80 transition-all duration-300">
        <div id="mainFullContent" class="glass-panel p-4 rounded-xl overflow-hidden">
            <div class="draggable-header text-sm font-bold text-gray-800 mb-3 border-b pb-2 flex justify-between items-center" data-target="controlContainer">
                <div class="flex items-center gap-2"><i class="fa-solid fa-layer-group text-blue-600"></i> Dashboard Geo</div>
                <div class="flex gap-1">
                    <button onclick="openSettings()" class="text-gray-500 hover:text-blue-600 p-1" title="Pengaturan"><i class="fa-solid fa-gear"></i></button>
                    <button onclick="toggleMinMax('controlContainer', true)" class="text-gray-500 hover:text-blue-600 p-1"><i class="fa-solid fa-compress"></i></button>
                </div>
            </div>
            
            <div class="space-y-4 max-h-[80vh] overflow-y-auto pr-1 custom-scrollbar">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="toggleModal('dataEntryModal', true)" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2.5 px-3 rounded-lg shadow flex items-center justify-center gap-2"><i class="fa-solid fa-upload"></i> Upload</button>
                    <button onclick="openDataManager()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2.5 px-3 rounded-lg shadow flex items-center justify-center gap-2"><i class="fa-solid fa-list-check"></i> Kelola</button>
                </div>

                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 space-y-2">
                    <label class="text-[10px] font-bold text-indigo-800 uppercase"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AI & Pencarian</label>
                    <div class="relative">
                        <input type="text" id="aiCommandInput" placeholder="Cth: -3.33944 114.56820" class="ai-input w-full text-xs p-2 pr-8 rounded border border-gray-300" onkeypress="if(event.key==='Enter') handleAICommand()">
                        <button onclick="handleAICommand()" class="absolute right-1 top-1 text-indigo-600 p-1"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                    <div class="flex justify-between text-[10px]">
                        <span class="text-gray-500" id="dataCount">0 Data</span>
                        <button onclick="resetFilter()" class="text-red-500 hover:underline">Reset</button>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1.5">Peta Dasar</label>
                    <div class="grid grid-cols-3 gap-1 bg-gray-100 p-1 rounded-lg">
                        <button class="map-btn text-[10px] py-1.5 rounded text-gray-600" data-map="google_road" onclick="changeBaseMap('google_road')">Default</button>
                        <button class="map-btn map-btn-active text-[10px] py-1.5 rounded text-gray-600" data-map="google_sat" onclick="changeBaseMap('google_sat')">Globe/Sat</button>
                        <button class="map-btn text-[10px] py-1.5 rounded text-gray-600" data-map="google_terrain" onclick="changeBaseMap('google_terrain')">Terrain</button>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1.5">Mode Visual</label>
                    <select id="viewMode" onchange="renderLayer()" class="w-full bg-white border border-gray-300 text-gray-700 text-xs font-medium rounded-lg p-2">
                        <option value="heatmap">üî• Heatmap</option>
                        <option value="point">üìç Titik</option>
                        <option value="circle">‚≠ï Lingkaran</option>
                        <option value="line">üìà Garis</option>
                    </select>
                </div>

                <!-- Main Panel Radius Slider -->
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1.5">Ukuran / Radius (Cepat)</label>
                    <input type="range" id="radiusSlider" min="5" max="100" value="25" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                </div>

                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-gray-100">
                    <button onclick="askAIGeneral()" class="text-xs bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold py-2 rounded shadow-sm"><i class="fa-solid fa-chart-pie mr-1"></i> Analisis Data</button>
                    <button onclick="askAIArea()" class="text-xs bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold py-2 rounded shadow-sm"><i class="fa-solid fa-vector-square mr-1"></i> Analisis Area</button>
                </div>
            </div>
        </div>
        
        <div id="mainMiniContent" class="hidden draggable-header glass-panel w-12 h-12 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-50 shadow-lg hover:scale-110 transition-transform" onclick="toggleMinMax('controlContainer', false)">
            <i class="fa-solid fa-layer-group text-blue-600 text-lg"></i>
        </div>
    </div>

    <!-- MEASUREMENT PANEL -->
    <div id="measurePanel" class="absolute top-80 left-14 z-[1000] w-72 hidden">
        <div class="glass-panel p-4 rounded-xl">
            <div class="draggable-header text-sm font-bold text-gray-800 mb-2 flex justify-between items-center" data-target="measurePanel">
                <span><i class="fa-solid fa-ruler-combined text-green-600 mr-2"></i>Hasil Ukur</span>
                <button onclick="clearDrawings()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="bg-green-50 border border-green-200 rounded p-3 text-center">
                <span id="measureResult" class="text-2xl font-bold text-green-700 font-mono">0.00</span> <span class="text-xs text-green-600 font-bold">KM</span>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // --- GLOBAL STATE ---
        let rawData = [], displayData = [], activeLayer = null;
        let isUpdatingMap = false;
        
        // Default Config
        const defaultStyles = {
            point: { color: '#f97316', radius: 5, opacity: 0.9 },
            circle: { color: '#ef4444', radiusScale: 20, opacity: 0.5 },
            line: { color: '#2563eb', weight: 3, opacity: 0.8 },
            heatmap: { radius: 25, blur: 15, opacity: 0.8, max: 5 } 
        };
        let styleConfig = JSON.parse(JSON.stringify(defaultStyles));

        // --- INITIALIZATION ---
        const map = L.map('map', {center: [-6.200, 106.816], zoom: 11, zoomControl: false, preferCanvas: true});
        L.control.zoom({position: 'bottomright'}).addTo(map);

        // Google Maps Layers (Default: Satellite Hybrid)
        const baseLayers = {
            'google_road': L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }),
            'google_sat': L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }), // Hybrid as "Globe"
            'google_terrain': L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] })
        };
        baseLayers['google_sat'].addTo(map); // Changed default to Satellite
        const drawnItems = new L.FeatureGroup().addTo(map);

        // --- DOM CONTENT LOADED WRAPPER ---
        document.addEventListener('DOMContentLoaded', () => {
            // API Key Init
            const savedKey = localStorage.getItem('gemini_api_key') || "";
            const keyInput = document.getElementById('apiKeyInput');
            if(keyInput) keyInput.value = savedKey;

            // Slider Listener
            const rSlider = document.getElementById('radiusSlider');
            if(rSlider) {
                rSlider.addEventListener('input', function() { 
                    if (!isUpdatingMap) { 
                        requestAnimationFrame(() => { 
                            const val = parseInt(this.value); 
                            if(styleConfig.heatmap) styleConfig.heatmap.radius = val;
                            if (document.getElementById('viewMode').value === 'heatmap' && activeLayer) { 
                                activeLayer.setOptions({ radius: val }); 
                            } else { 
                                renderLayer(); 
                            } 
                            isUpdatingMap = false; 
                        }); 
                        isUpdatingMap = true; 
                    } 
                });
            }
        });

        // --- FUNCTIONS ---
        function getApiKey() { return localStorage.getItem('gemini_api_key') || ""; }
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) { localStorage.setItem('gemini_api_key', key); alert("API Key tersimpan!"); }
        }
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            const icon = document.getElementById('eyeIcon');
            if(input.type === 'password') { input.type='text'; icon.className='fa-solid fa-eye-slash'; }
            else { input.type='password'; icon.className='fa-solid fa-eye'; }
        }

        function openSettings() { toggleModal('settingsModal', true); switchStyleTab('point'); }
        function switchStyleTab(mode) {
            document.querySelectorAll('.style-tab').forEach(b => { b.classList.remove('setting-tab-active'); b.classList.add('text-gray-600', 'hover:bg-white'); });
            document.getElementById('tab-'+mode).classList.add('setting-tab-active');
            document.getElementById('tab-'+mode).classList.remove('text-gray-600');
            const styleWrap = document.getElementById('styleContentWrapper');
            const apiWrap = document.getElementById('apiContentWrapper');
            if(mode === 'api') { styleWrap.classList.add('hidden'); apiWrap.classList.remove('hidden'); }
            else { styleWrap.classList.remove('hidden'); apiWrap.classList.add('hidden'); 
                const titles = { 'point': 'Pengaturan Titik', 'circle': 'Pengaturan Lingkaran', 'line': 'Pengaturan Garis', 'heatmap': 'Pengaturan Heatmap' };
                document.getElementById('styleTitle').innerText = titles[mode];
                renderStyleControls(mode); 
            }
        }

        function renderStyleControls(mode) {
            const c = document.getElementById('styleControls');
            const cf = styleConfig[mode];
            let html = '';
            if (mode === 'heatmap') {
                html = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><label class="text-xs font-bold text-gray-500 block mb-2">Kepadatan untuk Merah (Threshold: <span id="label-${mode}-max">${cf.max}</span>)</label><input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="20" value="${cf.max}" oninput="updateConfig('${mode}', 'max', this.value)"><p class="text-[10px] text-gray-400 mt-1">Geser Kiri: Lebih Sensitif (Cepat Merah). Geser Kanan: Butuh banyak tumpukan.</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><label class="text-xs font-bold text-gray-500 block mb-2">Radius (<span id="label-${mode}-radius">${cf.radius}</span>px)</label><input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="5" max="100" value="${cf.radius}" oninput="updateConfig('${mode}', 'radius', this.value)"></div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><label class="text-xs font-bold text-gray-500 block mb-2">Blur (<span id="label-${mode}-blur">${cf.blur}</span>)</label><input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="5" max="100" value="${cf.blur}" oninput="updateConfig('${mode}', 'blur', this.value)"></div>`;
            } else {
                html = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-100 flex items-center justify-between"><div><label class="text-xs font-bold text-gray-500 block">Warna Utama</label></div><input type="color" value="${cf.color}" onchange="updateConfig('${mode}', 'color', this.value)"></div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><label class="text-xs font-bold text-gray-500 block mb-2">Transparansi (<span id="label-${mode}-opacity">${cf.opacity}</span>)</label><input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="0.1" max="1" step="0.1" value="${cf.opacity}" oninput="updateConfig('${mode}', 'opacity', this.value)"></div>`;
                if(mode === 'point') html += `<div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><label class="text-xs font-bold text-gray-500 block mb-2">Ukuran (<span id="label-${mode}-radius">${cf.radius}</span>px)</label><input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="2" max="20" value="${cf.radius}" oninput="updateConfig('${mode}', 'radius', this.value)"></div>`;
                if(mode === 'circle') html += `<div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><label class="text-xs font-bold text-gray-500 block mb-2">Skala Radius (<span id="label-${mode}-radiusScale">${cf.radiusScale}</span>x)</label><input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="5" max="100" value="${cf.radiusScale}" oninput="updateConfig('${mode}', 'radiusScale', this.value)"></div>`;
                if(mode === 'line') html += `<div class="bg-gray-50 p-4 rounded-lg border border-gray-100"><label class="text-xs font-bold text-gray-500 block mb-2">Ketebalan (<span id="label-${mode}-weight">${cf.weight}</span>px)</label><input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="10" value="${cf.weight}" oninput="updateConfig('${mode}', 'weight', this.value)"></div>`;
            }
            c.innerHTML = html;
        }

        function updateConfig(mode, key, val) {
            if(key !== 'color') val = parseFloat(val);
            styleConfig[mode][key] = val;
            const label = document.getElementById(`label-${mode}-${key}`);
            if(label) label.innerText = val;
            if (!isUpdatingMap) { requestAnimationFrame(() => { updateActiveLayerStyle(mode); isUpdatingMap = false; }); isUpdatingMap = true; }
        }

        function updateActiveLayerStyle(mode) {
            if (document.getElementById('viewMode').value !== mode || !activeLayer) return;
            const cf = styleConfig[mode];
            if (mode === 'heatmap') { activeLayer.setOptions({ radius: cf.radius, blur: cf.blur, max: cf.max }); } 
            else {
                activeLayer.eachLayer(layer => {
                    if (mode === 'point') { if (layer.setRadius) layer.setRadius(cf.radius); if (layer.setStyle) layer.setStyle({ fillColor: cf.color, fillOpacity: cf.opacity, opacity: cf.opacity }); }
                    else if (mode === 'circle') { if (layer.setRadius) layer.setRadius(cf.radiusScale); if (layer.setStyle) layer.setStyle({ color: cf.color, opacity: cf.opacity }); }
                    else if (mode === 'line') { if (layer instanceof L.Polyline && !(layer instanceof L.CircleMarker)) layer.setStyle({ color: cf.color, weight: cf.weight, opacity: cf.opacity }); }
                });
            }
        }

        function applyStyles() { renderLayer(); toggleModal('settingsModal', false); }
        function resetStyles() { styleConfig = JSON.parse(JSON.stringify(defaultStyles)); const t = document.querySelector('.setting-tab-active').id.replace('tab-', ''); if(t!=='api') renderStyleControls(t); renderLayer(); }

        // --- DATA ---
        function toggleModal(id, show) {
            const m = document.getElementById(id);
            if(show) { m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10); }
            else { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('dropZone').classList.add('hidden');
            const reader = new FileReader();
            reader.onload = function(e) {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                processData(json);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(json) {
            let newData = [];
            let latKey, lonKey;
            const keys = Object.keys(json[0] || {});
            keys.forEach(k => { const l = k.toLowerCase(); if(l.includes('lat')) latKey=k; else if(l.includes('lon')||l.includes('lng')) lonKey=k; });
            let combinedKey = null;
            if (!latKey || !lonKey) { keys.forEach(k => { const val = json[0][k]; if (typeof val === 'string' && val.trim().match(/^-?\d+(\.\d+)?\s+-?\d+(\.\d+)?$/)) combinedKey = k; }); }
            if(!latKey && !lonKey && !combinedKey) return alert("Kolom Latitude/Longitude tidak ditemukan. Pastikan ada kolom yang mengandung 'lat' dan 'lon' atau 'lng'.");

            json.forEach(row => {
                let lat, lng;
                if (combinedKey) { const parts = row[combinedKey].toString().trim().split(/[\s,;]+/); if(parts.length >= 2) { lat = parseFloat(parts[0]); lng = parseFloat(parts[1]); } } 
                else { lat = parseFloat(row[latKey]); lng = parseFloat(row[lonKey]); }

                if(!isNaN(lat) && !isNaN(lng)) {
                    let d = null, t = null, s = null;
                    keys.forEach(k => {
                        const l = k.toLowerCase();
                        if(l.includes('date') || l.includes('tgl')) d = row[k];
                        if(l.includes('time') || l.includes('jam')) t = row[k];
                        if(l.includes('speed') || l.includes('kecepatan')) s = parseFloat(row[k]);
                    });
                    if(typeof d === 'number') d = new Date(Math.round((d - 25569)*86400*1000)).toISOString().split('T')[0]; else if(!d) d = new Date().toISOString().split('T')[0];
                    if(typeof t === 'number') { let sec = Math.round(t * 86400); t = `${String(Math.floor(sec/3600)).padStart(2,'0')}:${String(Math.floor((sec%3600)/60)).padStart(2,'0')}`; } else if(!t) t = "00:00";
                    newData.push({ lat: lat, lng: lng, date: d, time: t, speed: s, props: row });
                }
            });

            if(newData.length > 0) { rawData = newData; displayData = [...rawData]; map.fitBounds(L.latLngBounds(newData.map(d=>[d.lat,d.lng]))); updateUI(); toggleModal('dataEntryModal', false); } 
            else alert("Data tidak valid.");
        }

        function resetUpload() { document.getElementById('fileInput').value = ''; document.getElementById('fileInfo').classList.add('hidden'); document.getElementById('dropZone').classList.remove('hidden'); }
        function generateDummyData() {
            rawData=[]; const clat=-6.200, clng=106.816;
            for(let i=0; i<50; i++) {
                let spd = Math.random() > 0.2 ? Math.floor(Math.random()*100) : 0;
                let h = Math.floor(i/2); let m = (i%2)*30;
                let time = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                let date = '2023-11-22';
                let row = { 'Latitude': clat, 'Longitude': clng, 'Tanggal': date, 'Jam': time, 'Kecepatan': spd, 'Driver': 'Budi', 'Status': 'Aktif' };
                rawData.push({ lat: clat+(Math.random()-0.5)*0.05, lng: clng+(Math.random()-0.5)*0.05, date: date, time: time, speed: spd, props: row });
            }
            displayData=[...rawData]; map.fitBounds(L.latLngBounds(rawData.map(d=>[d.lat,d.lng]))); updateUI(); toggleModal('dataEntryModal', false);
        }

        function openDataManager() {
            toggleModal('dataManagerModal', true);
            const table = document.getElementById('mainDataTable');
            table.innerHTML = '';
            document.getElementById('managerCount').innerText = rawData.length;
            if(rawData.length === 0) return;
            const headers = Object.keys(rawData[0].props);
            let thead = '<thead><tr><th class="w-10">#</th>';
            headers.forEach(h => thead += `<th>${h}</th>`);
            thead += '<th class="w-10 text-center">Aksi</th></tr></thead>';
            table.innerHTML = thead;
            let tbody = '<tbody>';
            const limit = Math.min(rawData.length, 100);
            for(let i=0; i<limit; i++) {
                const d = rawData[i];
                tbody += `<tr><td class="text-gray-400 text-xs">${i+1}</td>`;
                headers.forEach(h => {
                    let val = d.props[h];
                    if(typeof val === 'object' && val !== null) val = JSON.stringify(val);
                    if(typeof val === 'number' && val % 1 !== 0) val = val.toFixed(5);
                    tbody += `<td>${val !== undefined ? val : '-'}</td>`;
                });
                tbody += `<td class="text-center"><i class="fa-solid fa-trash-can btn-delete-row cursor-pointer text-red-500" onclick="deleteRow(${i})"></i></td></tr>`;
            }
            tbody += '</tbody>';
            table.innerHTML += tbody;
        }

        function deleteRow(i) { if(confirm("Hapus?")) { rawData.splice(i,1); displayData=[...rawData]; openDataManager(); updateUI(); } }
        function clearAllData() { if(confirm("Hapus SEMUA?")) { rawData=[]; displayData=[]; openDataManager(); updateUI(); } }
        function updateUI() { document.getElementById('dataCount').innerText = `${displayData.length} Data`; renderLayer(); }

        // --- RENDER ---
        function renderLayer() {
            if(map.getSize().x === 0) { setTimeout(renderLayer, 200); return; }
            if(activeLayer) { map.removeLayer(activeLayer); activeLayer=null; }
            const mode = document.getElementById('viewMode').value;
            const cf = styleConfig[mode];

            if(mode === 'heatmap') {
                activeLayer = L.heatLayer(displayData.map(d=>[d.lat,d.lng, 1]), { 
                    radius: cf.radius, blur: cf.blur, max: cf.max,
                    gradient: {0.0: 'blue', 0.3: 'lime', 0.5: 'yellow', 0.7: 'orange', 1.0: 'red'}
                }).addTo(map);
                setupClick(true);
            } else if(mode === 'line') {
                const sortedData = [...displayData].sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
                activeLayer = L.featureGroup();
                const latlngs = sortedData.map(d => [d.lat, d.lng]);
                L.polyline(latlngs, { color: cf.color, weight: cf.weight, opacity: cf.opacity }).addTo(activeLayer);
                activeLayer.addTo(map);
                setupClick(false);
            } else {
                activeLayer = L.featureGroup();
                setupClick(false);
                const limit = Math.min(displayData.length, 2000);
                for(let i=0; i<limit; i++) {
                    const d = displayData[i];
                    let m;
                    if(mode==='point') m = L.circleMarker([d.lat,d.lng], {radius: cf.radius, fillColor: cf.color, color:'#fff', weight:1, fillOpacity: cf.opacity});
                    else m = L.circle([d.lat,d.lng], {radius: cf.radiusScale, color: cf.color, weight:1, opacity: cf.opacity});
                    m.bindPopup(createPopup(d)).addTo(activeLayer);
                }
                activeLayer.addTo(map);
            }
        }

        function setupClick(isHeatmap) {
            map.off('click');
            if(isHeatmap) {
                map.on('click', e => {
                    let closest=null, minDist=Infinity;
                    displayData.forEach(d => {
                        const dist = Math.sqrt(Math.pow(d.lat-e.latlng.lat,2) + Math.pow(d.lng-e.latlng.lng,2));
                        if(dist < minDist) { minDist=dist; closest=d; }
                    });
                    if(closest && minDist < 0.005) L.popup().setLatLng([closest.lat,closest.lng]).setContent(createPopup(closest)).openOn(map);
                });
            }
        }

        function createPopup(d) {
            let content = `<div class='font-sans text-left min-w-[150px]'>`;
            content += `<div class="bg-blue-50 p-2 -mx-3 -mt-3 mb-2 border-b border-blue-100 rounded-t text-center"><b class="text-blue-800">Info Data</b></div>`;
            for (const [key, value] of Object.entries(d.props)) {
                let displayVal = value;
                if(typeof value === 'number' && value % 1 !== 0) displayVal = value.toFixed(5);
                content += `<div class="flex justify-between text-xs mb-1"><span class="text-gray-500 font-medium mr-2">${key}:</span> <span class="text-gray-800">${displayVal}</span></div>`;
            }
            content += `<div class="mt-2 pt-2 border-t border-gray-100 text-center"><a href="https://www.google.com/maps?q=&layer=c&cbll=${d.lat},${d.lng}" target="_blank" class="text-blue-600 underline text-xs font-bold">Lihat Street View</a></div>`;
            content += `</div>`;
            return content;
        }

        // --- AI & MISC ---
        async function callAI(prompt) {
            const key = getApiKey(); if(!key) return alert("API Key Needed!");
            document.getElementById('aiProcessing').style.display = 'flex';
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{parts:[{text: prompt}]}] })
                });
                const d = await res.json(); return d.candidates[0].content.parts[0].text;
            } catch(e) { alert("AI Error"); } finally { document.getElementById('aiProcessing').style.display = 'none'; }
        }
        async function handleAICommand() {
            const q = document.getElementById('aiCommandInput').value.trim(); if(!q) return;
            const cr = /^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/; const m = q.match(cr);
            if (m) { map.setView([parseFloat(m[1]), parseFloat(m[3])], 15); L.popup().setLatLng([parseFloat(m[1]), parseFloat(m[3])]).setContent(`<b>üìç Koordinat</b><br>${m[1]}, ${m[3]}`).openOn(map); return; }
            const p = `User: "${q}". JSON ONLY: { "action": "NAVIGATE"|"FILTER"|"RESET", "lat": num, "lng": num, "zoom": 13, "label": "name", "expr": "JS bool (d.date,d.time,d.lat)" }`;
            try { const t = await callAI(p); const a = JSON.parse(t.replace(/```json|```/g,'').trim());
                if(a.action==='NAVIGATE') { map.setView([a.lat,a.lng], 13); L.popup().setLatLng([a.lat,a.lng]).setContent(`üìç ${a.label}`).openOn(map); }
                else if(a.action==='FILTER') { const f = rawData.filter(new Function('d', `try{return ${a.expr}}catch{return false}`)); if(f.length) { displayData=f; updateUI(); } else alert("0 Data."); }
                else if(a.action==='RESET') resetFilter();
            } catch(e) { console.log(e); }
        }
        async function askAIGeneral() { if(!displayData.length) return alert("Data kosong"); const s = displayData.slice(0,15).map(d=>`${d.lat},${d.lng},${d.time}`).join('\n'); const txt = await callAI(`Analisis data (Total ${displayData.length}):\n${s}\nFokus: Rawan kecelakaan?`); showAIResult(txt); }
        async function askAIArea() { if(!currentDrawnLayer) return alert("Gambar area dulu."); const txt = await callAI(`Analisis area: ${currentDrawnLayer.getLatLngs().toString().substring(0,500)}... Rawan kecelakaan?`); showAIResult(txt); }
        function showAIResult(txt) { document.getElementById('aiOutput').innerHTML = marked.parse(txt); toggleModal('aiModal', true); }
        function closeAIModal() { toggleModal('aiModal', false); }
        function changeBaseMap(t) { Object.values(baseLayers).forEach(l => map.removeLayer(l)); map.addLayer(baseLayers[t]); document.querySelectorAll('.map-btn').forEach(b => { b.classList.toggle('map-btn-active', b.dataset.map===t); b.classList.toggle('text-gray-600', b.dataset.map!==t); }); }
        function toggleMinMax(id, min) { const c = document.getElementById(id); if(min) { c.classList.remove('w-80'); c.classList.add('w-auto'); document.getElementById('mainFullContent').classList.add('hidden'); document.getElementById('mainMiniContent').classList.remove('hidden'); } else { c.classList.remove('w-auto'); c.classList.add('w-80'); document.getElementById('mainMiniContent').classList.add('hidden'); document.getElementById('mainFullContent').classList.remove('hidden'); } }
        function resetFilter() { displayData=[...rawData]; updateUI(); document.getElementById('aiCommandInput').value=''; }
        
        const drawControl = new L.Control.Draw({ draw: { polyline:{metric:true}, polygon:{showArea:true}, rectangle:{showArea:true}, circle:false, marker:false }, edit: { featureGroup: drawnItems } }); map.addControl(drawControl);
        map.on(L.Draw.Event.CREATED, e => { drawnItems.clearLayers(); drawnItems.addLayer(e.layer); currentDrawnLayer=e.layer; document.getElementById('measurePanel').classList.remove('hidden'); updateMeasure(e.layer); });
        function updateMeasure(l) { let val=0; if(l.getLatLngs) { const lls = l.getLatLngs().flat(2); for(let i=0; i<lls.length-1; i++) val += lls[i].distanceTo(lls[i+1]); } document.getElementById('measureResult').innerText = (val/1000).toFixed(2); }
        function clearDrawings() { drawnItems.clearLayers(); currentDrawnLayer=null; document.getElementById('measurePanel').classList.add('hidden'); }
        let activeDragEl=null, initialX, initialY; const dragOffsets = {'controlContainer':{x:0,y:0}, 'measurePanel':{x:0,y:0}};
        document.addEventListener("mousedown", e => { let h = e.target.closest('.draggable-header'); if(!h || e.target.closest('button') || e.target.closest('input')) return; const id = h.getAttribute('data-target'); if(id) { activeDragEl = document.getElementById(id); initialX = e.clientX - dragOffsets[id].x; initialY = e.clientY - dragOffsets[id].y; } });
        document.addEventListener("mouseup", () => activeDragEl=null);
        document.addEventListener("mousemove", e => { if(activeDragEl) { e.preventDefault(); const x = e.clientX - initialX; const y = e.clientY - initialY; dragOffsets[activeDragEl.id] = {x,y}; activeDragEl.style.transform = `translate3d(${x}px, ${y}px, 0)`; } });
    </script>
</body>
</html>
