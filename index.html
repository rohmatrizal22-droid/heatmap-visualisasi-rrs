<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Geo-Analisis (Big Data Ready)</title>
    
    <style>
        /* 1. BASE THEME: Deep Blue Background */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background-color: #0f172a; }
        #map { height: 100vh; width: 100%; z-index: 1; cursor: crosshair; }
        
        /* 2. GLASS PANEL */
        .glass-panel {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 8px 32px rgba(15, 23, 42, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 3. COMPONENTS */
        .loader { border: 3px solid #dbeafe; border-top: 3px solid #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .draggable-header { cursor: grab; color: #1e3a8a; } 
        .draggable-header:active { cursor: grabbing; }
        
        .ai-input { border: 1px solid #cbd5e1; color: #334155; }
        .ai-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        
        /* Pegman */
        .custom-pegman-control {
            background: white; border-radius: 6px; border: 1px solid #bfdbfe;
            box-shadow: 0 2px 6px rgba(15, 23, 42, 0.3); cursor: pointer;
            width: 34px; height: 34px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 12px !important; transition: all 0.2s; color: #1e40af;
        }
        .custom-pegman-control:hover { background: #eff6ff; color: #2563eb; }
        .pegman-active { background: #22c55e !important; color: white !important; border-color: #16a34a !important; }
        .cursor-streetview { cursor: url('https://maps.gstatic.com/mapfiles/openhand_8_8.cur'), pointer !important; }

        /* Tables & UI */
        .data-table-container { max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .data-table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.75rem; }
        .data-table th { position: sticky; top: 0; background: #f1f5f9; padding: 10px 8px; border-bottom: 2px solid #cbd5e1; color: #334155; font-weight: 700; }
        .data-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; color: #475569; }
        .data-table tr:hover { background-color: #e0f2fe; cursor: pointer; }
        
        .file-drop-zone { border: 2px dashed #93c5fd; transition: all 0.3s; background: #f0f9ff; border-radius: 12px; }
        .file-drop-zone:hover { border-color: #2563eb; background-color: #dbeafe; }

        input[type="color"] { -webkit-appearance: none; border: none; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 8px; border: 1px solid #cbd5e1; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .setting-tab-active { background-color: #eff6ff; color: #1d4ed8; border-right: 4px solid #2563eb; }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column-reverse; gap: 10px; pointer-events: none; }
        .toast { background: rgba(15, 23, 42, 0.9); color: white; padding: 12px 24px; border-radius: 8px; font-size: 0.875rem; font-weight: 500; box-shadow: 0 4px 6px rgba(0,0,0,0.1); backdrop-filter: blur(4px); animation: fadeInUp 0.3s ease-out; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .toast-error { background: rgba(220, 38, 38, 0.9); border-color: rgba(248, 113, 113, 0.3); }
        .toast-success { background: rgba(22, 163, 74, 0.9); border-color: rgba(74, 222, 128, 0.3); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes bounceIn { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <!-- MARKER CLUSTER CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900">

    <div id="toast-container"></div>

    <div id="aiProcessing" class="fixed top-4 right-4 bg-white z-[9999] hidden items-center gap-3 p-3 rounded-lg shadow-lg border border-blue-200 animate-bounce-in">
        <div class="loader"></div> <span class="text-xs text-blue-900 font-bold">AI Sedang Menganalisis...</span>
    </div>

    <!-- FLOATING ROUTE INFO PANEL -->
    <div id="routeInfoPanel" class="fixed top-20 right-4 z-[1000] w-72 glass-panel rounded-xl overflow-hidden shadow-2xl hidden animate-bounce-in">
        <div class="draggable-header bg-purple-50 p-3 border-b border-purple-100 flex justify-between items-center cursor-grab active:cursor-grabbing" data-target="routeInfoPanel">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-route text-purple-600"></i>
                <span class="text-xs font-bold text-purple-900 uppercase tracking-wider">Info Rute</span>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="toggleRouteMin()" class="text-slate-400 hover:text-purple-600 w-6 h-6 rounded hover:bg-purple-100 flex items-center justify-center transition-colors"><i class="fa-solid fa-window-minimize text-xs -mt-1" id="routeMinIcon"></i></button>
                <button onclick="clearRoute()" class="text-slate-400 hover:text-red-500 w-6 h-6 rounded hover:bg-red-50 flex items-center justify-center transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
        <div id="routeInfoContent" class="p-4 bg-white/50 backdrop-blur-sm transition-all duration-300">
            <div class="grid grid-cols-2 gap-3 mb-2">
                <div class="text-center p-2 bg-white border border-purple-100 rounded shadow-sm">
                    <span class="text-[10px] text-slate-500 font-bold uppercase block mb-0.5">Jarak</span>
                    <span class="text-lg font-bold text-purple-700" id="floatDist">-</span>
                </div>
                <div class="text-center p-2 bg-white border border-purple-100 rounded shadow-sm">
                    <span class="text-[10px] text-slate-500 font-bold uppercase block mb-0.5">Waktu</span>
                    <span class="text-lg font-bold text-purple-700" id="floatDur">-</span>
                </div>
            </div>
            <div class="text-[10px] text-center text-slate-400 italic">*Kecepatan: <span id="floatSpeedInfo">standar</span></div>
        </div>
    </div>

    <!-- ROUTING MODAL -->
    <div id="routingModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-4 border-b border-purple-100 bg-purple-50 flex justify-between items-center">
                <h3 class="font-bold text-purple-900"><i class="fa-solid fa-route text-purple-600 mr-2"></i> Kalkulator Rute</h3>
                <button onclick="toggleModal('routingModal', false)" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-5 space-y-4">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">Titik A (Asal)</label>
                    <div class="relative"><i class="fa-solid fa-location-dot absolute left-3 top-3 text-blue-500"></i><input type="text" id="routeStart" class="w-full pl-9 p-2.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Masukan Lat,Lon atau Alamat..."></div>
                </div>
                <div class="flex justify-center -my-2 relative z-10">
                    <button onclick="swapRouteInputs()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full p-2 border border-slate-200 shadow-sm transition-transform hover:rotate-180"><i class="fa-solid fa-arrow-right-arrow-left fa-rotate-90 text-xs"></i></button>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">Titik B (Tujuan)</label>
                    <div class="relative"><i class="fa-solid fa-flag-checkered absolute left-3 top-3 text-red-500"></i><input type="text" id="routeEnd" class="w-full pl-9 p-2.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Masukan Lat,Lon atau Alamat..."></div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">Kecepatan Rata-rata (Opsional)</label>
                    <div class="relative"><i class="fa-solid fa-gauge-high absolute left-3 top-3 text-orange-500"></i><input type="number" id="routeSpeed" class="w-full pl-9 p-2.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Km/Jam (Misal: 40)"></div>
                </div>
                <button onclick="calculateRoute()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2.5 rounded-lg shadow-md transition-all flex justify-center items-center gap-2"><i class="fa-solid fa-calculator"></i> Hitung & Tampilkan</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 flex flex-col h-[600px]">
            <div class="p-4 border-b border-blue-100 bg-blue-50 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-blue-900 text-lg"><i class="fa-solid fa-sliders text-blue-600 mr-2"></i> Pengaturan</h3>
                <button onclick="toggleModal('settingsModal', false)" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-1/3 bg-slate-50 border-r border-slate-200 p-3 flex flex-col gap-2 overflow-y-auto custom-scrollbar">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 px-2">Visual</div>
                    <button onclick="switchStyleTab('point')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-point"><i class="fa-solid fa-circle-dot text-orange-500"></i> Titik (Cluster)</button>
                    <button onclick="switchStyleTab('heatmap')" class="style-tab setting-tab-active w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-heatmap"><i class="fa-solid fa-fire text-red-500"></i> Heatmap</button>
                    <button onclick="switchStyleTab('circle')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-circle"><i class="fa-regular fa-circle text-blue-500"></i> Lingkaran</button>
                    <button onclick="switchStyleTab('line')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-line"><i class="fa-solid fa-route text-green-500"></i> Garis</button>
                    <div class="my-2 border-t border-slate-200"></div>
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 px-2">Sistem</div>
                    <button onclick="switchStyleTab('api')" class="style-tab w-full text-left px-4 py-3 rounded-lg hover:bg-white transition-all text-sm font-medium flex items-center gap-2" id="tab-api"><i class="fa-solid fa-key text-slate-600"></i> API Key</button>
                </div>
                <div class="w-2/3 p-6 overflow-y-auto custom-scrollbar bg-white relative">
                    <div id="styleContentWrapper">
                        <h4 class="text-lg font-bold text-blue-900 mb-1" id="styleTitle">Pengaturan Heatmap</h4>
                        <div id="styleControls" class="space-y-6"></div>
                    </div>
                    <div id="apiContentWrapper" class="hidden">
                        <h4 class="text-lg font-bold text-blue-900 mb-1">Konfigurasi API</h4>
                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 mt-4">
                            <label class="text-sm font-bold text-blue-800 block mb-2">Gemini API Key</label>
                            <div class="relative">
                                <input type="password" id="apiKeyInput" class="w-full p-3 pr-20 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm" placeholder="Tempel API Key di sini...">
                                <button onclick="toggleApiKeyVisibility()" class="absolute right-2 top-3 text-slate-400 hover:text-blue-600"><i class="fa-solid fa-eye" id="eyeIcon"></i></button>
                            </div>
                            <div class="flex justify-end mt-3">
                                <button onclick="saveApiKey()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition-colors"><i class="fa-solid fa-save mr-1"></i> Simpan</button>
                            </div>
                            <p class="text-xs text-blue-600 mt-3"><i class="fa-solid fa-info-circle mr-1"></i>Key tersimpan lokal di browser Anda.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center shrink-0">
                <button onclick="resetStyles()" class="text-red-500 hover:text-red-700 text-sm font-bold px-3">Reset Default</button>
                <button onclick="toggleModal('settingsModal', false)" class="bg-blue-800 hover:bg-blue-900 text-white text-sm px-6 py-2.5 rounded-lg font-bold shadow hover:shadow-lg transition-all">Tutup</button>
            </div>
        </div>
    </div>

    <!-- DATA ENTRY MODAL -->
    <div id="dataEntryModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-green-100 bg-green-50 flex justify-between items-center">
                <h3 class="font-bold text-green-900"><i class="fa-solid fa-file-excel text-green-600 mr-2"></i> Upload Excel (Big Data Ready)</h3>
                <button onclick="toggleModal('dataEntryModal', false)" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-8 flex flex-col items-center">
                <div id="dropZone" class="file-drop-zone w-full h-48 rounded-xl flex flex-col items-center justify-center cursor-pointer mb-4 relative">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this)">
                    <i class="fa-solid fa-cloud-arrow-up text-5xl text-blue-300 mb-3"></i>
                    <p class="text-sm text-slate-600 font-medium">Tarik File Excel ke sini</p>
                    <p class="text-xs text-slate-400 mt-1">Support 50.000+ Baris (.xlsx, .csv)</p>
                </div>
                <div id="fileInfo" class="hidden w-full bg-green-50 border border-green-200 rounded-lg p-3 flex justify-between items-center">
                    <span class="text-xs text-green-800 font-medium"><i class="fa-solid fa-check-circle mr-1"></i> <span id="fileName">file.xlsx</span></span>
                    <button onclick="resetUpload()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                </div>
                <button onclick="generateDummyData()" class="mt-4 w-full py-2 text-xs font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">Generate 1.000 Data Dummy</button>
            </div>
        </div>
    </div>

    <!-- DATA MANAGER MODAL -->
    <div id="dataManagerModal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
            <div class="p-4 border-b border-blue-100 bg-blue-50 flex justify-between items-center">
                <h3 class="font-bold text-blue-900"><i class="fa-solid fa-list-check text-blue-600 mr-2"></i> Kelola Data</h3>
                <button onclick="toggleModal('dataManagerModal', false)" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs text-slate-500 font-bold">Total: <span id="managerCount">0</span></span>
                    <button onclick="clearAllData()" class="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded font-bold hover:bg-red-200 transition-colors">Hapus Semua</button>
                </div>
                <div class="data-table-container flex-1 custom-scrollbar">
                    <table class="data-table" id="mainDataTable"></table>
                </div>
                <div id="tableFooter" class="mt-2 text-center"></div>
            </div>
        </div>
    </div>

    <!-- AI OUTPUT MODAL -->
    <div id="aiModal" class="fixed inset-0 bg-black/50 z-[9999] hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[80vh] border-t-4 border-blue-600">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-blue-900 font-bold"><i class="fa-solid fa-robot mr-2 text-blue-600"></i> Hasil Analisis</h3>
                <button onclick="closeAIModal()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="aiOutput" class="p-6 overflow-y-auto prose text-sm text-slate-700 flex-1 custom-scrollbar"></div>
        </div>
    </div>

    <!-- MAIN CONTROL PANEL -->
    <div id="controlContainer" class="absolute top-4 left-14 z-[1000] w-80 transition-all duration-300">
        <div id="mainFullContent" class="glass-panel p-4 rounded-xl overflow-hidden">
            <!-- HEADER DIUBAH DARI 'DASHBOARD SATELIT' KE 'VISUAL SATELIT' -->
            <div class="draggable-header text-sm font-bold text-blue-900 mb-3 border-b border-blue-100 pb-2 flex justify-between items-center" data-target="controlContainer">
                <div class="flex items-center gap-2"><i class="fa-solid fa-earth-asia text-blue-600"></i> Visual Satelit</div>
                <div class="flex gap-1">
                    <button onclick="openSettings()" class="text-slate-400 hover:text-blue-600 p-1" title="Pengaturan"><i class="fa-solid fa-gear"></i></button>
                    <button onclick="toggleMinMax('controlContainer', true)" class="text-slate-400 hover:text-blue-600 p-1"><i class="fa-solid fa-compress"></i></button>
                </div>
            </div>
            
            <div class="space-y-4 max-h-[80vh] overflow-y-auto pr-1 custom-scrollbar">
                <!-- Primary Actions -->
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="toggleModal('dataEntryModal', true)" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2.5 px-3 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-upload"></i> Upload</button>
                    <button onclick="openDataManager()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2.5 px-3 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-list-check"></i> Kelola</button>
                </div>
                
                <!-- ROUTING BUTTON -->
                <button onclick="toggleModal('routingModal', true)" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs font-bold py-2.5 px-3 rounded-lg border border-purple-200 shadow-sm flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-route"></i> Kalkulator Jarak Tempuh
                </button>

                <!-- AI Search -->
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 space-y-2">
                    <label class="text-[10px] font-bold text-blue-800 uppercase"><i class="fa-solid fa-magnifying-glass mr-1"></i> Pencarian & AI</label>
                    <div class="relative">
                        <input type="text" id="aiCommandInput" placeholder="Cari Lokasi / Filter Data..." class="ai-input w-full text-xs p-2 pr-8 rounded border border-slate-200 bg-white" onkeypress="if(event.key==='Enter') handleAICommand()">
                        <button onclick="handleAICommand()" class="absolute right-1 top-1 text-blue-600 p-1 hover:text-blue-800"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                    <div class="flex justify-between text-[10px] pt-1">
                        <span class="text-slate-500 font-medium" id="dataCount">0 Data</span>
                        <button onclick="resetFilter()" class="text-red-500 hover:text-red-700 font-bold">Reset</button>
                    </div>
                </div>

                <!-- NEW: MAP CLICK ACTIONS MENU -->
                <div id="mapClickActions" class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 space-y-2 hidden">
                    <label class="text-[10px] font-bold text-yellow-800 uppercase flex items-center gap-1"><i class="fa-solid fa-crosshairs"></i> Koordinat Peta</label>
                    <div id="clickedCoords" class="text-xs font-mono text-slate-700 bg-white p-2 rounded border border-yellow-100"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="analyzeAiBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-bold py-1.5 px-1 rounded shadow flex items-center justify-center gap-1"><i class="fa-solid fa-robot"></i> Analisis AI</button>
                        <a id="streetViewBtn" target="_blank" class="bg-green-500 hover:bg-green-600 text-white text-[10px] font-bold py-1.5 px-1 rounded shadow flex items-center justify-center gap-1 no-underline"><i class="fa-solid fa-street-view"></i> Street View</a>
                    </div>
                    <div class="flex gap-1">
                        <button id="setRouteAbtn" class="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-700 text-[10px] font-bold py-1.5 px-1 rounded shadow text-center">Set Mulai (A)</button>
                        <button id="setRouteBbtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white text-[10px] font-bold py-1.5 px-1 rounded shadow text-center">Set Tujuan (B)</button>
                    </div>
                    <!-- Tombol Reset Aksi Peta -->
                    <button onclick="resetMapClickActions()" class="w-full text-[10px] font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 py-1 rounded">Reset Aksi Peta</button>
                </div>

                <!-- Map Mode Info -->
                <div class="text-xs text-slate-500 text-center font-medium bg-slate-100 p-1.5 rounded border border-slate-200">
                    Peta Dasar: <span class="text-blue-600">Satelit Hybrid (Google)</span>
                </div>

                <!-- Visual Mode -->
                <div>
                    <label class="text-xs font-bold text-slate-600 block mb-1.5">Mode Visualisasi</label>
                    <div class="relative">
                        <select id="viewMode" onchange="renderLayer()" class="w-full bg-white border border-slate-300 text-slate-700 text-xs font-bold rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                            <option value="point">üìç Titik (Cluster) - Ringan</option>
                            <option value="heatmap">üî• Heatmap (Density)</option>
                            <option value="circle">‚≠ï Lingkaran (Radius)</option>
                            <option value="line">üìà Garis (Jalur)</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-slate-400 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <!-- Analysis Buttons -->
                <div class="grid grid-cols-2 gap-2 pt-2 border-t border-slate-100">
                    <button onclick="askAIGeneral()" class="text-xs bg-white border border-slate-200 text-slate-700 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700 font-bold py-2 rounded shadow-sm transition-all"><i class="fa-solid fa-chart-pie mr-1 text-blue-500"></i> Analisis Data</button>
                    <button onclick="askAIArea()" class="text-xs bg-white border border-slate-200 text-slate-700 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700 font-bold py-2 rounded shadow-sm transition-all"><i class="fa-solid fa-vector-square mr-1 text-green-500"></i> Analisis Area</button>
                </div>
            </div>
        </div>
        
        <!-- Minimized Icon -->
        <div id="mainMiniContent" class="hidden draggable-header glass-panel w-12 h-12 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-50 border border-blue-200 shadow-lg hover:scale-110 transition-transform" onclick="toggleMinMax('controlContainer', false)">
            <i class="fa-solid fa-earth-asia text-blue-600 text-lg"></i>
        </div>
    </div>

    <!-- MEASUREMENT PANEL -->
    <div id="measurePanel" class="absolute top-80 left-14 z-[1000] w-72 hidden">
        <div class="glass-panel p-4 rounded-xl">
            <div class="draggable-header text-sm font-bold text-blue-900 mb-2 flex justify-between items-center" data-target="measurePanel">
                <span><i class="fa-solid fa-ruler-combined text-green-600 mr-2"></i>Hasil Ukur</span>
                <button onclick="clearDrawings()" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
            </div>
            <div class="bg-green-50 border border-green-200 rounded p-3 text-center">
                <span id="measureResult" class="text-2xl font-bold text-green-700 font-mono">0.00</span> <span class="text-xs text-green-600 font-bold">KM</span>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Tambahkan GeometryUtil untuk perhitungan Area Poligon -->
    <script src="https://unpkg.com/leaflet-geometryutil@0.10.1/leaflet.geometryutil.js"></script>
    <!-- MARKER CLUSTER JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // --- GLOBAL STATE ---
        let rawData = [], displayData = [], activeLayer = null, currentDrawnLayer = null;
        let isUpdatingMap = false;
        let pegmanMode = false;
        let routeLayer = null; // Store current route
        let isRouteMinimized = false;
        let currentPage = 1;
        // NILAI itemsPerPage DIUBAH DARI 20 (asumsi sebelumnya) MENJADI 50
        const itemsPerPage = 50; 
        
        const defaultStyles = {
            point: { color: '#f97316', radius: 5, opacity: 0.9 },
            circle: { color: '#ef4444', radiusScale: 20, opacity: 0.5 },
            line: { color: '#2563eb', weight: 3, opacity: 0.8 },
            heatmap: { radius: 20, blur: 15, opacity: 0.7, max: 1.0 }
        };
        let styleConfig = JSON.parse(JSON.stringify(defaultStyles));

        // --- INITIALIZATION ---
        const map = L.map('map', {center: [-6.200, 106.816], zoom: 11, zoomControl: false, preferCanvas: true});
        L.control.zoom({position: 'bottomright'}).addTo(map);

        // HTTPS Google Maps Layers
        const baseLayers = {
            'google_road': L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }),
            'google_sat': L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }), 
            'google_terrain': L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] })
        };
        baseLayers['google_sat'].addTo(map);
        const drawnItems = new L.FeatureGroup().addTo(map);

        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'toast-error' : type === 'success' ? 'toast-success' : ''}`;
            
            let icon = '<i class="fa-solid fa-circle-info text-blue-400"></i>';
            if(type === 'error') icon = '<i class="fa-solid fa-triangle-exclamation text-red-200"></i>';
            if(type === 'success') icon = '<i class="fa-solid fa-circle-check text-green-200"></i>';
            
            toast.innerHTML = `${icon}<span>${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- ROUTING LOGIC (OSRM & NOMINATIM) ---
        function swapRouteInputs() {
            const a = document.getElementById('routeStart');
            const b = document.getElementById('routeEnd');
            const temp = a.value; a.value = b.value; b.value = temp;
        }

        async function geocodeAddress(query) {
            const coordMatch = query.match(/^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/);
            if(coordMatch) return { lat: parseFloat(coordMatch[1]), lon: parseFloat(coordMatch[3]) };
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const data = await res.json();
                if(data && data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                throw new Error("Alamat tidak ditemukan");
            } catch(e) { console.error(e); throw e; }
        }

        async function calculateRoute() {
            const startIn = document.getElementById('routeStart').value;
            const endIn = document.getElementById('routeEnd').value;
            const speedVal = parseFloat(document.getElementById('routeSpeed').value);

            if(!startIn || !endIn) return showToast("Isi kedua titik lokasi!", 'error');
            showToast("Mencari rute...", 'info');

            try {
                const start = await geocodeAddress(startIn);
                const end = await geocodeAddress(endIn);

                const url = `https://router.project-osrm.org/route/v1/driving/${start.lon},${start.lat};${end.lon},${end.lat}?overview=full&geometries=geojson`;
                const res = await fetch(url);
                const data = await res.json();

                if(data.code !== 'Ok') throw new Error("Gagal menghitung rute");

                const route = data.routes[0];
                const distKm = (route.distance / 1000).toFixed(2);
                let durMin, speedInfo = "standar (OSRM)";
                if (!isNaN(speedVal) && speedVal > 0) {
                   durMin = Math.round(((route.distance / 1000) / speedVal) * 60);
                   speedInfo = `${speedVal} km/jam`;
                } else {
                   durMin = Math.round(route.duration / 60);
                }
                
                document.getElementById('floatDist').innerText = `${distKm} km`;
                document.getElementById('floatDur').innerText = `${durMin} menit`;
                document.getElementById('floatSpeedInfo').innerText = speedInfo;
                
                isRouteMinimized = false;
                document.getElementById('routeInfoContent').classList.remove('hidden');
                document.getElementById('routeMinIcon').className = 'fa-solid fa-window-minimize text-xs -mt-1';
                document.getElementById('routeInfoPanel').classList.remove('hidden');
                toggleModal('routingModal', false);

                if(routeLayer) map.removeLayer(routeLayer);
                
                const geoJson = { "type": "FeatureCollection", "features": [{ "type": "Feature", "properties": {}, "geometry": route.geometry }] };
                routeLayer = L.layerGroup([
                    L.geoJSON(geoJson, { style: { color: '#9333ea', weight: 5, opacity: 0.8 } }),
                    L.marker([start.lat, start.lon]).bindPopup('<b>Mulai</b><br>' + startIn),
                    L.marker([end.lat, end.lon]).bindPopup('<b>Tujuan</b><br>' + endIn)
                ]).addTo(map);

                map.fitBounds(L.geoJSON(geoJson).getBounds(), { padding: [50, 50] });
                showToast("Rute ditemukan!", 'success');
            } catch(e) { showToast(e.message || "Gagal memproses permintaan", 'error'); }
        }

        function clearRoute() {
            if(routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
            document.getElementById('routeInfoPanel').classList.add('hidden');
            showToast("Rute dihapus", 'info');
        }

        function toggleRouteMin() {
            const content = document.getElementById('routeInfoContent');
            const icon = document.getElementById('routeMinIcon');
            isRouteMinimized = !isRouteMinimized;
            if (isRouteMinimized) { content.classList.add('hidden'); icon.className = 'fa-regular fa-window-maximize text-xs'; } 
            else { content.classList.remove('hidden'); icon.className = 'fa-solid fa-window-minimize text-xs -mt-1'; }
        }

        // --- CUSTOM PEGMAN CONTROL ---
        const PegmanControl = L.Control.extend({
            options: { position: 'bottomright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control custom-pegman-control');
                const btn = L.DomUtil.create('a', 'pegman-btn', container);
                btn.href = "#"; btn.title = "Mode Street View";
                btn.innerHTML = '<i class="fa-solid fa-street-view fa-lg"></i>';
                btn.style.display = 'flex'; btn.style.alignItems = 'center'; btn.style.justifyContent = 'center';
                btn.style.width = '100%'; btn.style.height = '100%'; btn.style.textDecoration = 'none';
                btn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); toggleStreetViewMode(container); };
                return container;
            }
        });
        map.addControl(new PegmanControl());

        function toggleStreetViewMode(container) {
            pegmanMode = !pegmanMode;
            if (pegmanMode) {
                container.classList.add('pegman-active');
                document.getElementById('map').classList.add('cursor-streetview');
                document.getElementById('map').style.cursor = ''; 
            } else {
                container.classList.remove('pegman-active');
                document.getElementById('map').classList.remove('cursor-streetview');
                document.getElementById('map').style.cursor = 'crosshair';
            }
        }

        // --- EXPORTED GLOBAL FUNCTIONS ---
        window.analyzeLocation = analyzeLocation;
        window.analyzeDataPoint = analyzeDataPoint;
        window.zoomToData = zoomToData;
        window.setRouteStart = setRouteStart;
        window.setRouteEnd = setRouteEnd;

        /**
         * Creates the HTML content for the default map click popup (Non-Pegman mode).
         * SIMPLIFIED: Only shows coordinates. Actions are moved to the menu.
         */
        function createMapClickPopup(lat, lng) {
            return `<div class="text-center font-sans p-1 min-w-[150px]"><b class="text-blue-900">Lokasi Dipilih</b><br><span class="text-xs text-slate-500">${lat}, ${lng}</span></div>`;
        }

        /**
         * Updates the action panel in the main menu with the clicked coordinates.
         */
        function updateMapClickActions(lat, lng) {
            const coords = `${lat}, ${lng}`;
            const mapClickActionsDiv = document.getElementById('mapClickActions');

            mapClickActionsDiv.classList.remove('hidden');
            document.getElementById('clickedCoords').innerText = coords;

            // Update button actions with current coordinates
            document.getElementById('analyzeAiBtn').setAttribute('onclick', `analyzeLocation(${lat}, ${lng})`);
            document.getElementById('streetViewBtn').setAttribute('href', `https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}`);
            document.getElementById('setRouteAbtn').setAttribute('onclick', `setRouteStart('${coords}')`);
            document.getElementById('setRouteBbtn').setAttribute('onclick', `setRouteEnd('${coords}')`);
        }

        /**
         * Hides the map click actions menu. Added per user request to clean up menu.
         */
        function resetMapClickActions() {
            document.getElementById('mapClickActions').classList.add('hidden');
            document.getElementById('clickedCoords').innerText = '';
            // Optional: Close any open popups on the map
            map.closePopup();
        }

        // --- DOM LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('gemini_api_key') || "";
            const keyInput = document.getElementById('apiKeyInput');
            if(keyInput) keyInput.value = savedKey;
            
            map.on('click', function(e) {
                // Check if a drawing control tooltip is visible (meaning a drawing operation is active)
                if(document.querySelector('.leaflet-draw-tooltip')) return;
                
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);

                if (pegmanMode) {
                    // Street View Mode: Open SV in a new tab
                    const svUrl = `https://www.google.com/maps?q=&layer=c&cbll=${e.latlng.lat},${e.latlng.lng}`;
                    window.open(svUrl, '_blank');
                } else {
                    // Normal Mode: Show detailed context menu popup
                    const content = createMapClickPopup(lat, lng);
                    L.popup().setLatLng(e.latlng).setContent(content).openOn(map);
                    // Update actions in the menu
                    updateMapClickActions(lat, lng);
                }
            });
        });

        function setRouteStart(coords) { 
            document.getElementById('routeStart').value = coords; 
            showToast("Titik A (Asal) ditetapkan!", 'success'); 
        }
        function setRouteEnd(coords) { 
            document.getElementById('routeEnd').value = coords; 
            showToast("Titik B (Tujuan) ditetapkan!", 'success'); 
            toggleModal('routingModal', true); 
        }

        // --- FUNCTIONS ---
        function getApiKey() { return localStorage.getItem('gemini_api_key') || ""; }
        function saveApiKey() { const key = document.getElementById('apiKeyInput').value.trim(); if(key) { localStorage.setItem('gemini_api_key', key); showToast("API Key tersimpan!", 'success'); } }
        function toggleApiKeyVisibility() { const input = document.getElementById('apiKeyInput'); const icon = document.getElementById('eyeIcon'); if(input.type === 'password') { input.type='text'; icon.className='fa-solid fa-eye-slash'; } else { input.type='password'; icon.className='fa-solid fa-eye'; } }

        function openSettings() { toggleModal('settingsModal', true); switchStyleTab('point'); }
        function switchStyleTab(mode) {
            document.querySelectorAll('.style-tab').forEach(b => { b.classList.remove('setting-tab-active'); b.classList.add('text-slate-500', 'hover:bg-white'); });
            document.getElementById('tab-'+mode).classList.add('setting-tab-active');
            document.getElementById('tab-'+mode).classList.remove('text-slate-500');
            const styleWrap = document.getElementById('styleContentWrapper');
            const apiWrap = document.getElementById('apiContentWrapper');
            if(mode === 'api') { styleWrap.classList.add('hidden'); apiWrap.classList.remove('hidden'); }
            else { styleWrap.classList.remove('hidden'); apiWrap.classList.add('hidden'); 
                const titles = { 'point': 'Pengaturan Titik', 'circle': 'Pengaturan Lingkaran', 'line': 'Pengaturan Garis', 'heatmap': 'Pengaturan Heatmap' };
                document.getElementById('styleTitle').innerText = titles[mode];
                renderStyleControls(mode); 
            }
        }

        function renderStyleControls(mode) {
            const c = document.getElementById('styleControls');
            const cf = styleConfig[mode];
            let html = `
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-center justify-between"><div><label class="text-xs font-bold text-blue-800 block">Warna Utama</label></div><input type="color" value="${cf.color}" onchange="updateConfig('${mode}', 'color', this.value)"></div>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><label class="text-xs font-bold text-blue-800 block mb-2">Transparansi (<span id="label-${mode}-opacity">${cf.opacity}</span>)</label><input type="range" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" min="0.1" max="1" step="0.1" value="${cf.opacity}" oninput="updateConfig('${mode}', 'opacity', this.value)"></div>`;
            if(mode === 'heatmap') {
                 html = `<div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><label class="text-xs font-bold text-blue-800 block mb-2">Kepadatan (<span id="label-${mode}-max">${cf.max}</span>)</label><input type="range" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" min="0.1" max="10" step="0.1" value="${cf.max}" oninput="updateConfig('${mode}', 'max', this.value)"></div><div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><label class="text-xs font-bold text-blue-800 block mb-2">Radius (<span id="label-${mode}-radius">${cf.radius}</span>px)</label><input type="range" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" min="5" max="100" value="${cf.radius}" oninput="updateConfig('${mode}', 'radius', this.value)"></div>`;
            }
            else if(mode === 'point') html += `<div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><label class="text-xs font-bold text-blue-800 block mb-2">Ukuran (<span id="label-${mode}-radius">${cf.radius}</span>px)</label><input type="range" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" min="2" max="20" value="${cf.radius}" oninput="updateConfig('${mode}', 'radius', this.value)"></div>`;
            else if(mode === 'circle') html += `<div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><label class="text-xs font-bold text-blue-800 block mb-2">Skala (<span id="label-${mode}-radiusScale">${cf.radiusScale}</span>x)</label><input type="range" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" min="5" max="100" value="${cf.radiusScale}" oninput="updateConfig('${mode}', 'radiusScale', this.value)"></div>`;
            else if(mode === 'line') html += `<div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><label class="text-xs font-bold text-blue-800 block mb-2">Tebal (<span id="label-${mode}-weight">${cf.weight}</span>px)</label><input type="range" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer" min="1" max="10" value="${cf.weight}" oninput="updateConfig('${mode}', 'weight', this.value)"></div>`;
            c.innerHTML = html;
        }

        function updateConfig(mode, key, val) {
            if(key !== 'color') val = parseFloat(val);
            styleConfig[mode][key] = val;
            const label = document.getElementById(`label-${mode}-${key}`);
            if(label) label.innerText = val;
            if (!isUpdatingMap) { requestAnimationFrame(() => { updateActiveLayerStyle(mode); isUpdatingMap = false; }); isUpdatingMap = true; }
        }

        function updateActiveLayerStyle(mode) {
            if (document.getElementById('viewMode').value !== mode || !activeLayer) return;
            const cf = styleConfig[mode];
            if (mode === 'heatmap') { activeLayer.setOptions({ radius: cf.radius, blur: cf.blur, max: cf.max }); } 
            else if (mode === 'point') { 
                // Cluster style update is tricky, easier to re-render or just let it be for now
            }
            else {
                activeLayer.eachLayer(layer => {
                     if (mode === 'circle') { if (layer.setRadius) layer.setRadius(cf.radiusScale); if (layer.setStyle) layer.setStyle({ color: cf.color, opacity: cf.opacity }); }
                    else if (layer instanceof L.Polyline && !(layer instanceof L.CircleMarker)) layer.setStyle({ color: cf.color, weight: cf.weight, opacity: cf.opacity });
                });
            }
        }

        function applyStyles() { renderLayer(); toggleModal('settingsModal', false); }
        function resetStyles() { styleConfig = JSON.parse(JSON.stringify(defaultStyles)); const t = document.querySelector('.setting-tab-active').id.replace('tab-', ''); if(t!=='api') renderStyleControls(t); renderLayer(); }

        // --- DATA ---
        function toggleModal(id, show) {
            const m = document.getElementById(id);
            if(show) { m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10); }
            else { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('dropZone').classList.add('hidden');
            const reader = new FileReader();
            reader.onload = function(e) {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                processData(json);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(json) {
            let newData = [];
            if (json.length === 0) { showToast("File kosong atau tidak dapat dibaca.", 'error'); resetUpload(); return; }

            let latKey, lonKey;
            const keys = Object.keys(json[0] || {});
            keys.forEach(k => { const l = k.toLowerCase(); if(l.includes('lat')) latKey=k; else if(l.includes('lon')||l.includes('lng')) lonKey=k; });
            let combinedKey = null;
            if (!latKey || !lonKey) { keys.forEach(k => { const val = json[0][k]; if (typeof val === 'string' && val.trim().match(/^(-?\d+(\.\d+)?)\s+-?\d+(\.\d+)?$/)) combinedKey = k; }); }
            if(!latKey && !lonKey && !combinedKey) return showToast("Kolom Latitude/Longitude tidak ditemukan.", 'error');

            json.forEach(row => {
                let lat, lng;
                if (combinedKey) { const parts = row[combinedKey].toString().trim().split(/[\s,;]+/); if(parts.length >= 2) { lat = parseFloat(parts[0]); lng = parseFloat(parts[1]); } } 
                else { lat = parseFloat(row[latKey]); lng = parseFloat(row[lonKey]); }
                if(!isNaN(lat) && !isNaN(lng)) { newData.push({ lat: lat, lng: lng, props: row }); }
            });

            if(newData.length > 0) { rawData = newData; displayData = [...rawData]; map.fitBounds(L.latLngBounds(newData.map(d=>[d.lat,d.lng])), { padding: [20, 20] }); updateUI(); toggleModal('dataEntryModal', false); } 
            else showToast("Data tidak valid (tidak ada koordinat yang terdeteksi).", 'error');
        }

        function resetUpload() { document.getElementById('fileInput').value = ''; document.getElementById('fileInfo').classList.add('hidden'); document.getElementById('dropZone').classList.remove('hidden'); }
        function generateDummyData() {
            rawData=[]; const clat=-6.200, clng=106.816;
            // Generate 1000 for demo, but code handles more
            for(let i=0; i<1000; i++) {
                const u = 1 - Math.random(); const v = 1 - Math.random();
                const randStdNormal = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
                let lat = clat + (randStdNormal * 0.05); let lng = clng + ((Math.random() - 0.5) * 0.08);
                let spd = Math.random() > 0.2 ? Math.floor(Math.random()*100) : 0;
                let h = Math.floor(i/20); let m = (i%60);
                let time = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                let date = '2023-11-22';
                let row = { 'Latitude': lat, 'Longitude': lng, 'Tanggal': date, 'Jam': time, 'Kecepatan': spd, 'Driver': 'Simulasi' };
                rawData.push({ lat: lat, lng: lng, props: row });
            }
            displayData=[...rawData]; map.fitBounds(L.latLngBounds(rawData.map(d=>[d.lat,d.lng])), { padding: [20, 20] }); updateUI(); toggleModal('dataEntryModal', false);
        }

        function openDataManager(page) {
            if (typeof page === 'number') currentPage = page;
            toggleModal('dataManagerModal', true);
            const table = document.getElementById('mainDataTable');
            table.innerHTML = '';
            document.getElementById('managerCount').innerText = rawData.length;
            
            if(rawData.length === 0) {
                document.getElementById('tableFooter').innerHTML = '<span class="text-slate-400 italic">Tidak ada data.</span>';
                return;
            }

            const headers = Object.keys(rawData[0].props);
            let thead = '<thead><tr><th class="w-10">#</th>';
            headers.forEach(h => thead += `<th>${h}</th>`);
            thead += '<th class="w-10 text-center">Aksi</th></tr></thead>';
            table.innerHTML = thead;
            
            let tbody = '<tbody>';
            
            // PAGINATION LOGIC (Ringan)
            const totalPages = Math.ceil(rawData.length / itemsPerPage);
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, rawData.length);
            
            for(let i=start; i<end; i++) {
                const d = rawData[i];
                tbody += `<tr class="hover:bg-blue-50 cursor-pointer transition-colors" onclick="zoomToData(${i})" title="Klik untuk lihat di peta"><td class="text-gray-400 text-xs">${i+1}</td>`;
                headers.forEach(h => {
                    let val = d.props[h];
                    if(typeof val === 'object' && val !== null) val = JSON.stringify(val);
                    if(typeof val === 'number' && val % 1 !== 0) val = val.toFixed(5);
                    tbody += `<td>${val !== undefined ? val : '-'}</td>`;
                });
                tbody += `<td class="text-center" onclick="event.stopPropagation()"><i class="fa-solid fa-trash-can btn-delete-row cursor-pointer text-red-500" onclick="deleteRow(${i})"></i></td></tr>`;
            }
            tbody += '</tbody>';
            table.innerHTML += tbody;

            // RENDER PAGINATION CONTROLS
            const footer = document.getElementById('tableFooter');
            footer.innerHTML = `
                <div class="flex justify-center items-center gap-4">
                    <button onclick="openDataManager(${currentPage - 1})" ${currentPage === 1 ? 'disabled class="text-slate-300 cursor-not-allowed"' : 'class="text-blue-600 hover:text-blue-800 font-bold"'}><i class="fa-solid fa-chevron-left"></i> Prev</button>
                    <span class="text-xs font-bold text-slate-600">Hal ${currentPage} / ${totalPages}</span>
                    <button onclick="openDataManager(${currentPage + 1})" ${currentPage === totalPages ? 'disabled class="text-slate-300 cursor-not-allowed"' : 'class="text-blue-600 hover:text-blue-800 font-bold"'} >Next <i class="fa-solid fa-chevron-right"></i></button>
                </div>
            `;
        }

        function zoomToData(index) {
            const d = rawData[index];
            if(!d) return;
            toggleModal('dataManagerModal', false);
            // If using Cluster, we need to zoom deep enough
            map.flyTo([d.lat, d.lng], 18, { duration: 1.5 });
            
            const content = createPopup(d);
            L.popup().setLatLng([d.lat, d.lng]).setContent(content).openOn(map);
        }

        function deleteRow(i) { 
            if(confirm("Apakah Anda yakin ingin menghapus baris data ini?")) { 
                rawData.splice(i,1); 
                displayData=[...rawData]; 
                openDataManager(currentPage); 
                updateUI(); 
            } 
        }

        function clearAllData() { 
            if(confirm("Apakah Anda yakin ingin menghapus SEMUA data?")) { 
                rawData=[]; 
                displayData=[]; 
                openDataManager(1); 
                updateUI(); 
                showToast("Semua data dihapus.", 'info');
            } 
        }

        function updateUI() { 
            document.getElementById('dataCount').innerText = `${displayData.length} Data`; 
            renderLayer(); 
        }

        // --- RENDER ---
        function renderLayer() {
            if(map.getSize().x === 0) { setTimeout(renderLayer, 200); return; }
            if(activeLayer) { map.removeLayer(activeLayer); activeLayer=null; }
            const mode = document.getElementById('viewMode').value;
            const cf = styleConfig[mode];

            if(displayData.length === 0) { showToast("Tidak ada data untuk ditampilkan.", 'info'); return; }

            if(mode === 'heatmap') {
                activeLayer = L.heatLayer(displayData.map(d=>[d.lat,d.lng, 1]), { 
                    radius: cf.radius, blur: cf.blur, max: cf.max,
                    gradient: { 0.0: 'navy', 0.3: 'blue', 0.5: 'lime', 0.7: 'yellow', 1.0: 'red' }
                }).addTo(map);
            } else if(mode === 'point') {
                // CLUSTERING MODE FOR BIG DATA (Disarankan untuk 100.000 data)
                activeLayer = L.markerClusterGroup({
                    chunkedLoading: true, // PENTING: Mencegah browser freeze saat memproses banyak data
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    // Custom icon creator function for consistency (optional)
                    iconCreateFunction: function(cluster) {
                        return L.divIcon({ 
                            html: `<div style="background-color: ${cf.color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; box-shadow: 0 0 5px rgba(0,0,0,0.3);">${cluster.getChildCount()}</div>`, 
                            className: 'custom-cluster', 
                            iconSize: [30, 30] 
                        });
                    }
                });
                
                const markers = displayData.map(d => {
                    const m = L.circleMarker([d.lat,d.lng], {
                        radius: cf.radius, 
                        fillColor: cf.color, 
                        color:'#fff', 
                        weight:1, 
                        fillOpacity: cf.opacity
                    });
                    m.bindPopup(createPopup(d));
                    return m;
                });
                
                activeLayer.addLayers(markers);
                map.addLayer(activeLayer);
            } else if(mode === 'line') {
                // Mode Jalur: Bisa sangat berat untuk 100.000 titik. Filter data disarankan!
                activeLayer = L.featureGroup();
                const latlngs = displayData.map(d => [d.lat, d.lng]);
                L.polyline(latlngs, { color: cf.color, weight: cf.weight, opacity: cf.opacity }).addTo(activeLayer);
                activeLayer.addTo(map);
            } else {
                // Circle mode (Standard Limit to prevent crash)
                activeLayer = L.featureGroup();
                const limit = Math.min(displayData.length, 2000); // Batasan aman untuk mode non-optimized
                for(let i=0; i<limit; i++) {
                    const d = displayData[i];
                    let m = L.circle([d.lat,d.lng], {radius: cf.radiusScale, color: cf.color, weight:1, opacity: cf.opacity});
                    m.bindPopup(createPopup(d)).addTo(activeLayer);
                }
                activeLayer.addTo(map);
            }
        }

        // HELPER: Format Time & Duration
        function formatExcelSerialDate(serial) {
            if (!serial) return "";
            const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        function formatExcelSerialTime(serial) {
            if (serial === undefined || serial === null) return "";
            let frac = serial % 1; 
            let totalSeconds = Math.round(frac * 86400);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(totalSeconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function formatDuration(secondsInput) {
            if (!secondsInput) return "";
            let val = parseFloat(secondsInput);
            let totalSeconds = Math.round(val);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(totalSeconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function createPopup(d) {
            let content = `<div class='font-sans text-left min-w-[150px]'>`;
            content += `<div class="bg-blue-50 p-2 -mx-3 -mt-3 mb-2 border-b border-blue-100 rounded-t text-center"><b class="text-blue-800">Info Data</b></div>`;
            
            for (const [key, value] of Object.entries(d.props)) {
                let displayVal = value;
                let kLower = key.toLowerCase();
                // Attempt to auto-format dates/times if they look like Excel serial numbers
                if (typeof value === 'number') {
                    if (kLower.includes('date') && value > 25569 && value < 100000) { displayVal = formatExcelSerialDate(value); }
                    else if (kLower.includes('time') && value < 1) { displayVal = formatExcelSerialTime(value); }
                    else if (kLower.includes('duration')) { displayVal = formatDuration(value); }
                    else if (value % 1 !== 0) { displayVal = value.toFixed(5); }
                }

                if(typeof value === 'object' && value !== null) displayVal = JSON.stringify(value);
                
                content += `<div class="flex justify-between text-xs mb-1"><span class="text-slate-500 font-medium mr-2">${key}:</span> <span class="text-slate-800">${displayVal}</span></div>`;
            }
            const dataStr = JSON.stringify(d.props).replace(/"/g, '&quot;');
            content += `
                <div class="mt-2 pt-2 border-t border-slate-100 flex gap-1">
                    <a href="https://www.google.com/maps?q=&layer=c&cbll=${d.lat},${d.lng}" target="_blank" class="flex-1 bg-green-500 hover:bg-green-600 text-white text-[10px] font-bold py-1 px-2 rounded text-center"><i class="fa-solid fa-street-view"></i> SV</a>
                    <button onclick='analyzeDataPoint(${d.lat}, ${d.lng}, ${dataStr})' class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-[10px] font-bold py-1 px-2 rounded"><i class="fa-solid fa-robot"></i> AI</button>
                </div>
            </div>`;
            return content;
        }

        // --- AI & MISC ---

        /**
         * Generic AI caller with simple retry and structured JSON support.
         * @param {string|object} promptOrPayload - String prompt for text or structured payload object.
         * @param {boolean} isStructured - True if payload already contains generationConfig for JSON output.
         */
        async function callAI(promptOrPayload, isStructured = false) {
            const key = getApiKey();
            if(!key) { showToast("API Key Needed! Buka Pengaturan.", 'error'); return null; }
            document.getElementById('aiProcessing').style.display = 'flex';
            
            let payload = promptOrPayload;
            if (!isStructured) {
                payload = { contents: [{parts:[{text: promptOrPayload}]}] };
                // Use search grounding for general analysis
                if (!promptOrPayload.includes("Analisis titik:")) {
                    payload.tools = [{ "google_search": {} }];
                }
            }

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const res = await fetch(apiUrl, {
                        method: 'POST', 
                        headers: {'Content-Type':'application/json'}, 
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const errorText = await res.text();
                        console.error("API Fetch Error:", errorText);
                        throw new Error(`API Error: ${res.status}`);
                    }
                    
                    const d = await res.json();
                    if (d.candidates && d.candidates[0].content.parts[0]) { 
                        return d.candidates[0].content.parts[0].text; 
                    }
                    throw new Error("Respon AI tidak valid.");

                } catch(e) { 
                    if (attempt < maxRetries - 1) { 
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay)); 
                    } else {
                        showToast("AI Error: " + e.message, 'error'); 
                        return null;
                    }
                }
            }
            return null;
        }
        
        async function analyzeLocation(lat, lng) {
            const prompt = `Analisis lokasi di koordinat ${lat}, ${lng}. Lakukan analisis Klasifikasi Jalan sesuai Undang-Undang No. 22 Tahun 2009. 1. Identifikasi nama jalan/daerah. 2. Fungsi Jalan. 3. Status Jalan. 4. Kondisi fisik.`;
            const txt = await callAI(prompt);
            document.getElementById('aiProcessing').style.display = 'none';
            if (txt) showAIResult(txt);
        }

        async function analyzeDataPoint(lat, lng, props) {
            const propStr = JSON.stringify(props, null, 2);
            const prompt = `Analisis titik: ${lat}, ${lng}. Data: ${propStr}. Lakukan analisis Klasifikasi Jalan (UU 22/2009) dan hubungkan dengan data. Berikan Rekomendasi keselamatan.`;
            const txt = await callAI(prompt);
            document.getElementById('aiProcessing').style.display = 'none';
            if (txt) showAIResult(txt);
        }

        async function handleAICommand() {
            const q = document.getElementById('aiCommandInput').value.trim(); 
            if(!q) return;

            // 1. Coordinate check
            const coordRegex = /^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/;
            const match = q.match(coordRegex);
            if (match) {
                const lat = parseFloat(match[1]), lng = parseFloat(match[3]);
                map.setView([lat, lng], 15);
                L.popup().setLatLng([lat, lng]).setContent(`<b>üìç Koordinat</b><br>${lat}, ${lng}`).openOn(map);
                return;
            }

            // 2. Structured AI Command (NAVIGATE/FILTER)
            const dataKeys = Object.keys(rawData[0]?.props || {});
            
            const prompt = `User wants to search, filter, or navigate based on the query: "${q}". Available data properties are: ${dataKeys.length ? dataKeys.join(', ') : 'Tidak ada data terunggah.'}. 
            If the query refers to a location (city, area, coordinates), return a NAVIGATE action.
            If the query asks for a filter condition (e.g., 'Kecepatan > 50', 'Driver = A'), return a FILTER action with the exact column name (case sensitive), the relational operator (e.g., =, >, <, >=, <=, !=), and the value. For string comparisons, assume '=' means substring match (case-insensitive) unless specified.
            If the user asks to reset the filter, return RESET.
            Return ONLY the JSON object.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            action: { type: "STRING", enum: ["NAVIGATE", "FILTER", "RESET"] },
                            column: { type: "STRING" },
                            operator: { type: "STRING", enum: ["=", ">", "<", ">=", "<=", "!="] },
                            value: { type: "STRING" },
                            lat: { type: "NUMBER" }, lng: { type: "NUMBER" }, zoom: { type: "NUMBER" }, label: { type: "STRING" }
                        },
                        required: ["action"]
                    }
                },
                tools: [{ "google_search": {} }] // Use search grounding for location searches
            };

            try {
                const txt = await callAI(payload, true); // Pass true for structured JSON
                if (!txt) return;

                const act = JSON.parse(txt.replace(/```json|```/g,'').trim());

                if(act.action === 'NAVIGATE') {
                    map.setView([act.lat, act.lng], act.zoom || 13);
                    L.popup().setLatLng([act.lat, act.lng]).setContent(`üìç ${act.label}`).openOn(map);
                }
                else if(act.action === 'FILTER' && rawData.length > 0) {
                    const { column, operator, value } = act;
                    if (!column || !operator || value === undefined) { showToast("AI Filter tidak lengkap. Coba perjelas kueri.", 'error'); return; }

                    const isNumeric = !isNaN(parseFloat(value)) && isFinite(value);
                    const numericValue = isNumeric ? parseFloat(value) : null;
                    const stringValue = String(value).toLowerCase();

                    const filtered = rawData.filter(d => {
                        const dataVal = d.props[column];
                        if (dataVal === undefined) return false;

                        // Numeric comparison
                        if (typeof dataVal === 'number' && isNumeric) {
                            switch (operator) {
                                case '>': return dataVal > numericValue;
                                case '<': return dataVal < numericValue;
                                case '>=': return dataVal >= numericValue;
                                case '<=': return dataVal <= numericValue;
                                case '!=': return dataVal !== numericValue;
                                case '=': default: return dataVal === numericValue;
                            }
                        }
                        // String comparison (substring match for '=')
                        else if (typeof dataVal === 'string') {
                            const dataStrLower = dataVal.toLowerCase();
                            switch (operator) {
                                case '!=': return !dataStrLower.includes(stringValue);
                                case '=': default: return dataStrLower.includes(stringValue);
                            }
                        }
                        return false;
                    });

                    if(filtered.length > 0) {
                        displayData = filtered;
                        updateUI();
                        showToast(`${filtered.length} data disaring (${column} ${operator} ${value}).`, 'success');
                    } else {
                        displayData = []; // Clear map if no match
                        updateUI();
                        showToast(`0 Data ditemukan untuk filter "${q}".`, 'error');
                    }
                }
                else if(act.action==='RESET') resetFilter();
            } catch(e) { 
                console.error("Error processing AI command:", e); 
                showToast("Gagal memproses AI command.", 'error'); 
            }
        }
        
        async function askAIGeneral() { 
            if(!displayData.length) return showToast("Data kosong", 'error'); 
            const s = displayData.slice(0,15).map(d=>{
                const props = Object.keys(d.props).map(k => `${k}: ${d.props[k]}`).join('; ');
                return `${d.lat},${d.lng}, {${props}}`;
            }).join('\n'); 
            const prompt = `Sampel data awal (15 baris) dari total ${displayData.length} data adalah:\n${s}\n. Lakukan analisis dan interpretasi data ini. Fokus pada Klasifikasi Jalan sesuai UU No. 22/2009 (Fungsi, Status, Kondisi) berdasarkan lokasi yang terdeteksi. Berikan rekomendasi umum.`;
            const txt = await callAI(prompt); 
            document.getElementById('aiProcessing').style.display = 'none';
            if (txt) showAIResult(txt); 
        }
        
        async function askAIArea() { 
            if(!currentDrawnLayer) return showToast("Gambar area (polygon/rectangle) menggunakan kontrol di kanan bawah peta terlebih dahulu.", 'error'); 
            const pts = currentDrawnLayer.getLatLngs().flat(2).map(p => `${p.lat}, ${p.lng}`).join('; ').substring(0, 1000);
            
            let dataInAreaCount = 0;
            // Simple check: This requires turf.js for proper polygon check, for simplicity we only check point/area interaction.
            // If the map is complex, we just use the boundary coordinates.
            
            const prompt = `Saya telah menggambar area di peta. Area ini didefinisikan oleh koordinat batas (dipotong untuk brevity): ${pts}. Total titik data yang diunggah adalah ${rawData.length}. Berikan analisis lokasi ini dengan fokus pada Klasifikasi Jalan (UU No. 22/2009).`;
            const txt = await callAI(prompt); 
            document.getElementById('aiProcessing').style.display = 'none';
            if (txt) showAIResult(txt); 
        }
        
        function showAIResult(txt) { 
            document.getElementById('aiProcessing').style.display = 'none';
            if (!txt) return; 
            document.getElementById('aiOutput').innerHTML = marked.parse(txt); 
            toggleModal('aiModal', true); 
        }
        function closeAIModal() { toggleModal('aiModal', false); }
        function toggleMinMax(id, min) { const c = document.getElementById(id); if(min) { c.classList.remove('w-80'); c.classList.add('w-auto'); document.getElementById('mainFullContent').classList.add('hidden'); document.getElementById('mainMiniContent').classList.remove('hidden'); } else { c.classList.remove('w-auto'); c.classList.add('w-80'); document.getElementById('mainMiniContent').classList.add('hidden'); document.getElementById('mainFullContent').classList.remove('hidden'); } }
        function resetFilter() { displayData=[...rawData]; updateUI(); document.getElementById('aiCommandInput').value=''; showToast("Filter dihapus, semua data ditampilkan.", 'info'); }
        const drawControl = new L.Control.Draw({ draw: { polyline:{metric:true}, polygon:{showArea:true}, rectangle:{showArea:true}, circle:false, marker:false }, edit: { featureGroup: drawnItems } }); map.addControl(drawControl);
        map.on(L.Draw.Event.CREATED, e => { drawnItems.clearLayers(); drawnItems.addLayer(e.layer); currentDrawnLayer=e.layer; document.getElementById('measurePanel').classList.remove('hidden'); updateMeasure(e.layer); });
        map.on(L.Draw.Event.EDITED, e => { e.layers.eachLayer(l => updateMeasure(l)); });
        map.on(L.Draw.Event.DELETED, e => { if (drawnItems.getLayers().length === 0) clearDrawings(); });
        function updateMeasure(l) { 
            let val=0, unit='km'; 
            if (l instanceof L.Polyline) { 
                const lls = l.getLatLngs().flat(2); 
                for(let i=0; i<lls.length-1; i++) val += lls[i].distanceTo(lls[i+1]);
                val = (val/1000).toFixed(2);
            } else if (l instanceof L.Polygon || l instanceof L.Rectangle) {
                 // Calculate area in square kilometers
                // This now correctly uses the imported L.GeometryUtil.geodesicArea
                val = L.GeometryUtil.geodesicArea(l.getLatLngs().flat(2)) / 1000000;
                val = val.toFixed(2);
                unit = 'km¬≤';
            }
            document.getElementById('measureResult').innerText = val; 
            document.querySelector('#measurePanel .bg-green-50 span:last-child').innerText = unit.toUpperCase();
        }
        function clearDrawings() { drawnItems.clearLayers(); currentDrawnLayer=null; document.getElementById('measurePanel').classList.add('hidden'); }
        let activeDragEl=null, initialX, initialY; 
        const dragOffsets = {'controlContainer':{x:0,y:0}, 'measurePanel':{x:0,y:0}, 'routeInfoPanel':{x:0,y:0}};
        document.addEventListener("mousedown", e => { let h = e.target.closest('.draggable-header'); if(!h || e.target.closest('button') || e.target.closest('input')) return; const id = h.getAttribute('data-target'); if(id) { activeDragEl = document.getElementById(id); initialX = e.clientX - dragOffsets[id].x; initialY = e.clientY - dragOffsets[id].y; } });
        document.addEventListener("mouseup", () => activeDragEl=null);
        document.addEventListener("mousemove", e => { if(activeDragEl) { e.preventDefault(); const x = e.clientX - initialX; const y = e.clientY - initialY; dragOffsets[activeDragEl.id] = {x,y}; activeDragEl.style.transform = `translate3d(${x}px, ${y}px, 0)`; } });
    </script>
</body>
</html>
