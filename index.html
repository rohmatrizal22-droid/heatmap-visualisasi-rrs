<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Dashboard Pro (Big Data Ready)</title>
    
    <style>
        /* 1. THEME: Modern Slate (Dark Mode Optimized - Lightweight) */
        :root { --bg-dark: #0f172a; --panel-bg: #1e293b; --accent: #3b82f6; --text-main: #e2e8f0; --border: #334155; }
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; overflow: hidden; background-color: var(--bg-dark); color: var(--text-main); }
        #map { height: 100vh; width: 100%; z-index: 1; cursor: crosshair; }
        
        /* 2. LIGHTWEIGHT PANEL */
        .ui-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            border-radius: 0.5rem;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        /* 3. COMPONENTS */
        .loader { border: 2px solid #334155; border-top: 2px solid var(--accent); border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .btn-action {
            background: #334155; color: #f1f5f9; border: 1px solid #475569;
            padding: 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-action:hover { background: #475569; border-color: #64748b; }
        .btn-primary { background: var(--accent); border-color: #2563eb; color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        .input-field {
            background: #0f172a; border: 1px solid var(--border); color: white;
            padding: 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; width: 100%;
            outline: none; transition: border-color 0.15s;
        }
        .input-field:focus { border-color: var(--accent); }

        /* Table */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        .data-table th { text-align: left; padding: 8px; background: #1e293b; color: #94a3b8; position: sticky; top: 0; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); color: #cbd5e1; }
        .data-table tr:hover { background: #334155; cursor: pointer; }

        /* Tabs */
        .tab-btn { padding: 0.6rem; font-size: 0.75rem; color: #94a3b8; cursor: pointer; border-bottom: 2px solid transparent; background: transparent; border:none; width: 100%; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; background: rgba(59, 130, 246, 0.1); }
        
        /* Leaflet Overrides */
        .leaflet-bar a { background-color: #1e293b !important; color: white !important; border-bottom: 1px solid #334155 !important; }
        .leaflet-bar a:hover { background-color: #334155 !important; }
        .leaflet-popup-content-wrapper { background: #1e293b; color: white; border: 1px solid #475569; border-radius: 4px; }
        .leaflet-popup-tip { background: #1e293b; }
        .leaflet-draw-toolbar a { background-color: #1e293b; color: white; border-color: #334155; }

        /* Progress Bar for Big Data */
        #progressWrapper { display: none; width: 100%; background: #334155; height: 4px; border-radius: 2px; margin-top: 5px; }
        #progressBar { height: 100%; background: #3b82f6; width: 0%; transition: width 0.2s; }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <!-- FLOATING MENU BUTTON -->
    <button id="openMenuBtn" onclick="togglePanel(true)" class="absolute top-4 right-4 z-[999] btn-action btn-primary shadow-lg hidden transition-all duration-300 hover:scale-105">
        <i class="fa-solid fa-bars text-lg"></i> <span class="ml-2">Menu</span>
    </button>

    <!-- PROCESSING INDICATOR -->
    <div id="aiProcessing" class="fixed top-16 right-4 z-[9999] hidden items-center gap-3 p-2 px-4 rounded-full bg-blue-900/90 border border-blue-700 shadow-lg animate-pulse">
        <div class="loader"></div> <span class="text-xs font-bold text-blue-100">Memproses...</span>
    </div>

    <!-- LEFT SIDEBAR CONTROL -->
    <div id="controlPanel" class="absolute top-4 left-4 z-[1000] w-80 flex flex-col gap-3 panel-visible">
        
        <div class="ui-panel p-0 overflow-hidden">
            <div class="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                <div class="flex items-center gap-2 font-bold text-sm text-blue-400">
                    <i class="fa-solid fa-earth-americas"></i> Geo-Dashboard
                </div>
                <button onclick="togglePanel(false)" class="text-slate-400 hover:text-red-400 transition-colors" title="Sembunyikan Menu">
                    <i class="fa-solid fa-chevron-left text-lg"></i>
                </button>
            </div>
            
            <div class="flex border-b border-slate-700">
                <button onclick="setTab('visual')" class="tab-btn active" id="tab-visual">Visual</button>
                <button onclick="setTab('tools')" class="tab-btn" id="tab-tools">Alat Ukur</button>
                <button onclick="setTab('data')" class="tab-btn" id="tab-data">Data</button>
            </div>

            <div class="p-4 max-h-[70vh] overflow-y-auto custom-scrollbar" id="panelContent">
                
                <!-- 1. VISUAL TAB -->
                <div id="view-visual" class="space-y-4">
                    <div class="relative">
                        <input type="text" id="aiSearch" placeholder="Cari lokasi..." class="input-field pr-8" onkeypress="if(event.key==='Enter') handleSearch()">
                        <button onclick="handleSearch()" class="absolute right-2 top-1.5 text-slate-400 hover:text-blue-400"><i class="fa-solid fa-search"></i></button>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Mode Peta</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setMapLayer('google_road')" class="btn-action text-xs">Jalan</button>
                            <button onclick="setMapLayer('google_sat')" class="btn-action text-xs bg-slate-700 border-blue-500 text-blue-400">Satelit</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Visualisasi Data</label>
                        <select id="vizMode" onchange="renderData()" class="input-field mb-2">
                            <option value="point">üìç Titik (Point)</option>
                            <option value="heatmap">üî• Heatmap</option>
                            <option value="line">üìà Garis (Jalur)</option>
                        </select>
                        <div class="flex items-center justify-between text-xs text-slate-400">
                            <span>Radius/Ukuran</span>
                            <input type="range" id="radiusSlider" min="2" max="50" value="10" class="w-20 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>
                    </div>
                </div>

                <!-- 2. TOOLS TAB -->
                <div id="view-tools" class="space-y-4 hidden">
                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                        <label class="text-[10px] font-bold text-green-400 uppercase mb-2 block"><i class="fa-solid fa-route mr-1"></i> Kalkulator Perjalanan</label>
                        <div class="space-y-2">
                            <input type="text" id="distA" placeholder="Titik A" class="input-field">
                            <input type="text" id="distB" placeholder="Titik B" class="input-field">
                            <div class="relative">
                                <input type="number" id="travelSpeed" placeholder="Kecepatan (km/jam)" class="input-field" value="40">
                                <span class="absolute right-3 top-2 text-xs text-slate-500">km/h</span>
                            </div>
                            <button onclick="calcDistanceAB()" class="btn-action btn-primary w-full">Hitung Jarak & Waktu</button>
                        </div>
                        <div id="distResult" class="hidden mt-2 p-2 bg-slate-900 rounded border border-yellow-500/30 text-center text-xs text-slate-300"></div>
                    </div>

                    <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                        <label class="text-[10px] font-bold text-purple-400 uppercase mb-2 block"><i class="fa-solid fa-map-pin mr-1"></i> Pin Lokasi (POI)</label>
                        <button onclick="toggleAddPinMode()" id="btnAddPin" class="btn-action w-full"><i class="fa-solid fa-plus"></i> Tambah Pin</button>
                    </div>
                </div>

                <!-- 3. DATA TAB -->
                <div id="view-data" class="space-y-4 hidden">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="document.getElementById('fileInput').click()" class="btn-action btn-primary"><i class="fa-solid fa-upload"></i> Upload Excel</button>
                        <button onclick="generateDummy()" class="btn-action"><i class="fa-solid fa-database"></i> Dummy 10k</button>
                        <input type="file" id="fileInput" accept=".xlsx,.csv" hidden onchange="handleFileUpload(this)">
                    </div>
                    
                    <!-- Progress Bar for Large Data -->
                    <div id="progressWrapper">
                        <div id="progressBar"></div>
                    </div>

                    <div class="flex justify-between items-center border-b border-slate-700 pb-1">
                        <span class="text-xs font-bold text-slate-400">Data: <span id="dataCount" class="text-white">0</span></span>
                        <button onclick="clearData()" class="text-xs text-red-400 hover:text-red-300">Hapus</button>
                    </div>

                    <div class="data-table-container h-48">
                        <table class="data-table" id="dataTable"></table>
                    </div>
                    <p class="text-[10px] text-slate-500 italic text-center">Klik baris untuk zoom. <br>Max 2000 titik ditampilkan (Heatmap unlimited).</p>
                </div>

            </div>

            <div class="p-2 bg-slate-900 border-t border-slate-800 flex justify-between items-center">
                <button onclick="openSettings()" class="text-slate-500 hover:text-white px-2 text-xs"><i class="fa-solid fa-key"></i> API Key</button>
                <span class="text-[10px] text-slate-600">v2.5 BigData</span>
            </div>
        </div>
    </div>

    <!-- MEASUREMENT RESULT FLOAT -->
    <div id="measureFloat" class="fixed top-4 left-1/2 -translate-x-1/2 z-[1000] ui-panel px-4 py-2 hidden flex-col items-center animate-fade-in border-t-4 border-green-500">
        <span class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Hasil Ukur</span>
        <span id="measureVal" class="text-xl font-bold text-green-400 font-mono my-1">0.00 KM</span>
        <button onclick="clearMeasurements()" class="text-[10px] text-red-400 hover:text-red-300 hover:underline">Hapus</button>
    </div>

    <!-- API SETTINGS MODAL -->
    <div id="apiModal" class="fixed inset-0 bg-black/80 z-[2000] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="ui-panel w-full max-w-sm p-5 bg-slate-900 border border-slate-700">
            <h3 class="font-bold text-blue-400 mb-3">Konfigurasi API</h3>
            <label class="text-xs text-slate-400 block mb-1">Gemini API Key</label>
            <input type="password" id="apiKeyInput" class="input-field mb-3" placeholder="Paste Key...">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('apiModal').classList.add('hidden')" class="btn-action">Tutup</button>
                <button onclick="saveKey()" class="btn-action btn-primary">Simpan</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // --- STATE ---
        let map, drawnItems, activeLayer;
        let appData = [];
        let isPinMode = false;
        const apiKeyKey = 'gemini_api_key';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initDraw();
            const k = localStorage.getItem(apiKeyKey);
            if(k) document.getElementById('apiKeyInput').value = k;
            const rSlider = document.getElementById('radiusSlider');
            if(rSlider) {
                rSlider.addEventListener('input', () => requestAnimationFrame(renderData));
            }
        });

        function initMap() {
            map = L.map('map', { center: [-6.200, 106.816], zoom: 12, zoomControl: false });
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            setMapLayer('google_sat');
            map.on('click', (e) => { if(isPinMode) addPin(e.latlng); });
        }

        function setMapLayer(type) {
            map.eachLayer((l) => { if(l._url) map.removeLayer(l); });
            let url = type === 'google_road' ? 'https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}' : 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}';
            L.tileLayer(url, { maxZoom: 20, attribution: 'Google Maps' }).addTo(map);
        }

        // --- DATA HANDLING (CHUNKED) ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                parseDataInChunks(json);
            };
            reader.readAsArrayBuffer(file);
        }

        function generateDummy() {
            // Generate 10,000 rows
            const d = [];
            for(let i=0; i<10000; i++) {
                d.push({
                    lat: -6.2 + (Math.random()-0.5)*0.2,
                    lng: 106.8 + (Math.random()-0.5)*0.2,
                    props: { ID: i, Val: Math.floor(Math.random()*100) }
                });
            }
            appData = d;
            updateDataUI();
            alert("10.000 Data Dummy Dimuat!");
        }

        function parseDataInChunks(json) {
            appData = [];
            const total = json.length;
            const chunkSize = 2000;
            let index = 0;
            const progress = document.getElementById('progressBar');
            const wrapper = document.getElementById('progressWrapper');
            
            wrapper.style.display = 'block';

            function processChunk() {
                const end = Math.min(index + chunkSize, total);
                for(let i=index; i<end; i++) {
                    const row = json[i];
                    let lat, lng;
                    Object.keys(row).forEach(k => {
                        if(k.toLowerCase().includes('lat')) lat = row[k];
                        if(k.toLowerCase().includes('lon') || k.toLowerCase().includes('lng')) lng = row[k];
                    });
                    if(!lat && !lng) {
                        Object.values(row).forEach(val => {
                            if(typeof val === 'string' && val.includes(',')) {
                                const parts = val.split(',');
                                if(!isNaN(parseFloat(parts[0]))) { lat = parts[0]; lng = parts[1]; }
                            }
                        });
                    }
                    if(lat && lng) appData.push({ lat: parseFloat(lat), lng: parseFloat(lng), props: row });
                }

                index = end;
                progress.style.width = (index/total*100) + '%';

                if(index < total) {
                    setTimeout(processChunk, 10);
                } else {
                    wrapper.style.display = 'none';
                    updateDataUI();
                    if(appData.length) map.fitBounds(L.latLngBounds(appData.slice(0,1000).map(d=>[d.lat,d.lng])));
                }
            }
            processChunk();
        }

        function updateDataUI() {
            document.getElementById('dataCount').innerText = appData.length;
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            // Only render first 100 rows to table to save memory
            appData.slice(0, 100).forEach((d, i) => {
                tbody.innerHTML += `<tr onclick="zoomTo(${d.lat},${d.lng})"><td>${i+1}</td><td>${d.lat.toFixed(4)}</td><td>${d.lng.toFixed(4)}</td></tr>`;
            });
            renderData();
        }
        
        function clearData() { appData = []; updateDataUI(); if(activeLayer) map.removeLayer(activeLayer); }
        function zoomTo(lat, lng) { map.flyTo([lat, lng], 18); L.marker([lat, lng]).addTo(map).bindPopup("Lokasi Data").openPopup(); }

        // --- VISUALIZATION ---
        function renderData() {
            if(activeLayer) map.removeLayer(activeLayer);
            const mode = document.getElementById('vizMode').value;
            const rad = parseInt(document.getElementById('radiusSlider').value);

            if(mode === 'heatmap') {
                // Heatmap handles 10k+ points easily
                activeLayer = L.heatLayer(appData.map(d=>[d.lat, d.lng, 1]), { radius: rad*1.5, blur: 15, gradient: {0.2:'blue', 0.5:'lime', 1:'red'} }).addTo(map);
            } else if(mode === 'line') {
                // Polyline handles many points well on canvas
                activeLayer = L.polyline(appData.map(d=>[d.lat, d.lng]), { color: '#3b82f6', weight: 2 }).addTo(map);
            } else {
                activeLayer = L.featureGroup();
                // LIMIT MARKERS to avoid crash
                const limit = Math.min(appData.length, 2000);
                if(appData.length > 2000) console.warn("Limiting markers to 2000 for performance");
                
                for(let i=0; i<limit; i++) {
                    const d = appData[i];
                    const m = mode === 'point' 
                        ? L.circleMarker([d.lat, d.lng], { radius: rad/2, color: '#f97316', fillColor:'#f97316', fillOpacity: 0.8 }) 
                        : L.circle([d.lat, d.lng], { radius: rad*10, color: '#ef4444', weight: 1 });
                    
                    // Minimal popup content
                    let info = `<b>Data #${i+1}</b><br>${d.lat}, ${d.lng}`;
                    m.bindPopup(info);
                    m.addTo(activeLayer);
                }
                activeLayer.addTo(map);
            }
        }

        // --- TOOLS: DISTANCE & TIME ---
        async function calcDistanceAB() {
            const aInput = document.getElementById('distA').value;
            const bInput = document.getElementById('distB').value;
            const speedInput = document.getElementById('travelSpeed').value;
            
            if(!aInput || !bInput) return alert("Isi Titik A dan B");
            if(!speedInput || speedInput <= 0) return alert("Isi Kecepatan");

            const key = localStorage.getItem(apiKeyKey);
            const isCoord = (str) => /^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(str);
            let latlngA, latlngB;

            if (isCoord(aInput) && isCoord(bInput)) {
                const a = aInput.split(',').map(Number); const b = bInput.split(',').map(Number);
                latlngA = L.latLng(a[0], a[1]); latlngB = L.latLng(b[0], b[1]);
                calculateAndDraw(latlngA, latlngB, speedInput);
            } else {
                if(!key) return alert("API Key diperlukan untuk pencarian.");
                document.getElementById('aiProcessing').style.display = 'flex';
                try {
                    const prompt = `Return JSON only: coordinates for "${aInput}" as origin and "${bInput}" as dest. Format: { "a": [lat, lon], "b": [lat, lon] }`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{parts:[{text: prompt}]}] })
                    });
                    const data = await res.json();
                    const coords = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim());
                    if(coords.a && coords.b) calculateAndDraw(L.latLng(coords.a), L.latLng(coords.b), speedInput);
                } catch(e) { alert("Gagal mencari lokasi."); } 
                finally { document.getElementById('aiProcessing').style.display = 'none'; }
            }
        }

        function calculateAndDraw(latlngA, latlngB, speedKmH) {
            if(window.distLine) map.removeLayer(window.distLine);
            if(window.distMarkers) window.distMarkers.forEach(m => map.removeLayer(m));
            window.distMarkers = [ L.marker(latlngA).addTo(map), L.marker(latlngB).addTo(map) ];
            window.distLine = L.polyline([latlngA, latlngB], { color: '#ec4899', dashArray: '10, 10', weight: 4 }).addTo(map);
            map.fitBounds([latlngA, latlngB], { padding: [50,50] });
            
            const distKm = latlngA.distanceTo(latlngB) / 1000;
            const timeHours = distKm / speedKmH;
            const h = Math.floor(timeHours);
            const m = Math.round((timeHours - h) * 60);
            const timeStr = h > 0 ? `${h} jam ${m} menit` : `${m} menit`;

            const resDiv = document.getElementById('distResult');
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = `<div>Jarak: <b class="text-green-400">${distKm.toFixed(2)} KM</b></div><div>Waktu: <b class="text-yellow-400">${timeStr}</b></div>`;
        }

        // --- TOOLS: POI ---
        function toggleAddPinMode() {
            isPinMode = !isPinMode;
            const btn = document.getElementById('btnAddPin');
            if(isPinMode) {
                btn.classList.add('btn-primary'); btn.innerHTML = '<i class="fa-solid fa-check"></i> Selesai'; map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.classList.remove('btn-primary'); btn.innerHTML = '<i class="fa-solid fa-plus"></i> Tambah Pin'; map.getContainer().style.cursor = '';
            }
        }
        function addPin(latlng) {
            const label = prompt("Nama Lokasi:", "Lokasi Baru");
            if(label) L.marker(latlng).addTo(map).bindPopup(`<b>${label}</b>`).openPopup();
        }

        // --- UI ---
        function togglePanel(show) {
            const p = document.getElementById('controlPanel');
            const btn = document.getElementById('openMenuBtn');
            if (show) { p.classList.remove('panel-hidden'); p.classList.add('panel-visible'); p.style.transform = 'translateX(0)'; p.style.opacity = '1'; btn.classList.add('hidden'); } 
            else { p.classList.remove('panel-visible'); p.classList.add('panel-hidden'); p.style.transform = 'translateX(-120%)'; p.style.opacity = '0'; btn.classList.remove('hidden'); }
        }
        function setTab(tab) {
            ['visual', 'tools', 'data'].forEach(t => { document.getElementById(`view-${t}`).classList.add('hidden'); document.getElementById(`tab-${t}`).classList.remove('active'); });
            document.getElementById(`view-${tab}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).classList.add('active');
        }
        function openSettings() { document.getElementById('apiModal').classList.remove('hidden'); }
        function saveKey() { localStorage.setItem(apiKeyKey, document.getElementById('apiKeyInput').value); alert("Key Saved"); document.getElementById('apiModal').classList.add('hidden'); }
        function initDraw() {
            drawnItems = new L.FeatureGroup().addTo(map);
            const drawControl = new L.Control.Draw({ draw: { polyline: { metric: true, shapeOptions: { color: '#f59e0b' } }, polygon: { showArea: true, shapeOptions: { color: '#10b981' } }, rectangle: { showArea: true, shapeOptions: { color: '#3b82f6' } }, circle: false, marker: false }, edit: { featureGroup: drawnItems } });
            map.addControl(drawControl);
            map.on(L.Draw.Event.CREATED, (e) => {
                const layer = e.layer; drawnItems.addLayer(layer);
                let val = 0;
                if(e.layerType === 'polyline') { const lls = layer.getLatLngs(); for(let i=0; i<lls.length-1; i++) val += lls[i].distanceTo(lls[i+1]); }
                else { const lls = layer.getLatLngs()[0]; for(let i=0; i<lls.length-1; i++) val += lls[i].distanceTo(lls[i+1]); val += lls[lls.length-1].distanceTo(lls[0]); }
                const ui = document.getElementById('measureFloat'); ui.classList.remove('hidden'); ui.classList.add('flex'); document.getElementById('measureVal').innerText = (val/1000).toFixed(2) + " KM";
            });
        }
        function clearMeasurements() { drawnItems.clearLayers(); if(window.distLine) map.removeLayer(window.distLine); if(window.distMarkers) window.distMarkers.forEach(m => map.removeLayer(m)); document.getElementById('measureFloat').classList.add('hidden'); document.getElementById('distResult').classList.add('hidden'); }
        async function handleSearch() {
            const q = document.getElementById('aiSearch').value; if(!q) return;
            if(q.match(/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/)) { const p = q.split(',').map(Number); map.setView(p, 16); return; }
            const key = localStorage.getItem(apiKeyKey); if(!key) return alert("API Key diperlukan.");
            document.getElementById('aiProcessing').style.display = 'flex';
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{parts:[{text: `Return JSON coords [lat, lon] for: ${q}`}]}] }) });
                const d = await res.json(); const coords = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim()); map.setView(coords, 14);
            } catch(e) {} finally { document.getElementById('aiProcessing').style.display = 'none'; }
        }
    </script>
</body>
</html>
